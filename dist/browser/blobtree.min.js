!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("three-full/builds/Three.cjs.js")):"function"==typeof define&&define.amd?define(["three-full/builds/Three.cjs.js"],e):t.Blobtree=e(t.THREE)}(this,function(t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var e,i,r={types:{},register:function(t,e){if(this.types[t])throw"Error : cannot register type "+t+", this name is already registered.";this[t]=e},fromJSON:function(t){var e=this.types[t.type];if(!e)throw"Error : type found in JSON ("+t.type+" is not registered in the Blobtree library.";return e.fromJSON(t.type)}},s=r,o={Value:2,Grad:4,Mat:8,NextStep:16,NextStepX:32,NextStepY:64,NextStepZ:128,NextStepOrtho:224,ValueGrad:6,ValueMat:10,GradMat:12,ValueGradMat:14},n=0,h=function(){this.id=n++,this.aabb=new t.Box3,this.valid_aabb=!1,this.parentNode=null};h.prototype.constructor=h,h.type="Element",s.register(h.type,h),h.prototype.toJSON=function(){return{type:this.getType()}},h.prototype.getParentNode=function(){return this.parentNode},h.prototype.getType=function(){return h.type},h.prototype.computeHelpVariables=function(){this.computeAABB()},h.prototype.computeAABB=function(){throw"Error : computeAABB is abstract, should have been overwritten"},h.prototype.getAABB=function(){return this.aabb},h.prototype.isValidAABB=function(){return this.valid_aabb},h.prototype.invalidAABB=function(){this.valid_aabb=!1,null!==this.parentNode&&this.parentNode.isValidAABB()&&this.parentNode.invalidAABB()},h.prototype.invalidAll=function(){this.invalidAABB()},h.prototype.prepareForEval=function(){throw"ERROR : prepareForEval is a virtual function, should be re-implemented in all element(error occured in Element.js"},h.prototype.value=function(t,e,i){throw"ERROR : value is an abstract function, should be re-implemented in all primitives(error occured in "+this.getType()+" primitive)"},h.prototype.numericalGradient=(e={v:0},i=["x","y","z"],function(t,r,s){for(var n=s||1e-5,h=0;h<3;++h)t[i[h]]=t[i[h]]+n,this.value(t,o.Value,e),r[i[h]]=e.v,t[i[h]]=t[i[h]]-2*n,this.value(t,o.Value,e),r[i[h]]=(r[i[h]]-e.v)/(2*n),t[i[h]]=t[i[h]]+n}),h.prototype.getAreas=function(){return[]},h.prototype.distanceTo=function(t){throw"ERROR : distanceTo is a virtual function, should be re-implemented in all primitives(error occured in "+this.getType()+" primitive)"},h.prototype.heuristicStepWithin=function(){throw"ERROR : heuristicStepWithin is a virtual function, should be re-implemented in all primitives(error occured in "+this.getType()+" primitive)"},h.prototype.trim=function(t,e,i){},h.prototype.count=function(t){return 0};var a=h,p=function(){a.call(this),this.children=[]};(p.prototype=Object.create(a.prototype)).constructor=p,p.type="Node",s.register(p.type,p),p.prototype.getType=function(){return p.type},p.prototype.toJSON=function(){var t=a.prototype.toJSON.call(this);t.children=[];for(var e=0;e<this.children.length;++e)t.children.push(this.children[e].toJSON());return t},p.prototype.prepareForEval=function(){console.error("prepareForEval is a pure virtual function, should be reimplemented in every node class")},p.prototype.invalidAll=function(){if(this.invalidAABB(),this.children)for(var t=0;t<this.children.length;t++)this.children[t].invalidAll()},p.prototype.destroy=function(){for(var t=this.children.slice(0,this.children.length),e=0;e<t.length;e++)t[e].destroy();if(0!==this.children.length)throw"Error : children length should be 0";if(null!==this.parentNode&&this.parentNode.removeChild(this),null!==this.parentNode)throw"Error : parent node should be null at this point";this.children.length=0},p.prototype.addChild=function(t){null!==t.parentNode&&t.parentNode.removeChild(t),this.children.push(t),t.parentNode=this,this.invalidAABB()},p.prototype.removeChild=function(t){for(var e=0,i=this.children;i[e]!==t&&e<i.length;)++e;if(e==i.length)throw"c does not belong to the children of this node";i[e]=i[i.length-1],i.pop(),this.invalidAABB(),t.parentNode=null},p.prototype.computeAABB=function(){this.aabb.makeEmpty();for(var t=0;t<this.children.length;t++)this.children[t].computeAABB(),this.aabb.union(this.children[t].getAABB())},p.prototype.getAreas=function(){if(!this.valid_aabb)throw"Error : cannot call getAreas on a not prepared for eval nod, please call PrepareForEval first. Node concerned is a "+this.getType();for(var t=[],e=0;e<this.children.length;e++)t.push.apply(t,this.children[e].getAreas());return t},p.prototype.distanceTo=function(t){for(var e=1e7,i=0;i<this.children.length;i++)e=Math.min(e,this.children[i].distanceTo(t));return e},p.prototype.heuristicStepWithin=function(){for(var t=1e7,e=0;e<this.children.length;e++)t=Math.min(t,this.children[e].heuristicStepWithin());return t},p.prototype.trim=function(t,e,i){for(var r=e.length,s=0;s<this.children.length;s++)this.children[s].getAABB().intersectsBox(t)||(e.push(this.children[s]),i.push(this));for(s=r;s<e.length;++s)this.removeChild(e[s]);for(s=0;s<this.children.length;s++)this.children[s].trim(t,e,i)},p.prototype.count=function(t){var e=0;this instanceof t&&e++;for(var i=0;i<this.children.length;i++)e+=this.children[i].count(t);return e};var l=p,u={};u.last_mov_pt=new t.Vector3,u.grad=new t.Vector3,u.eval_res={v:0,g:new t.Vector3(0,0,0)},u.vec=new t.Vector3,u.safeNewton3D=function(t,e,i,r,s,n,h){h.copy(e);for(var a=1,c=0,p=!1;2!=c&&a<=s&&!p;){if(this.last_mov_pt.copy(h),t.value(h,o.ValueGrad,this.eval_res),this.grad.copy(this.eval_res.g),0!==this.grad.x||0!==this.grad.y||0!==this.grad.z){var l=this.grad.length(),u=(i-this.eval_res.v)/l;if(u<r&&u>-r?(u=u>0?r/l:-r/l,c++):c=0,this.grad.normalize().multiplyScalar(u),h.add(this.grad),this.vec.subVectors(h,e).lengthSq()>n*n)return void h.copy(e)}else p=!0;++a}p&&h.copy(e)},u.safeNewton1D=function(e,i,r,s,n,h,a,c,p,l){if(0===r.x&&0===r.y&&0===r.z)throw"Error : search direction is null";if(c<=0)throw"Error: epsilon <= 0, convergence will nuke your face or loop";if(h<s||h>n)throw"Error : starting absc is not in boundaries";for(var u=h,_=new t.Vector3,v=0,m=0;n-s>c&&m<p;)e.value(_.copy(r).multiplyScalar(u).add(i),o.ValueGrad,this.eval_res),this.eval_res.v>a?s=u:n=u,0!==(v=this.eval_res.g.dot(r))?((u+=(a-this.eval_res.v)/v)>=n||u<=s)&&(u=.5*(n+s)):u=.5*(n+s),++m;l.p_absc=.5*(n+s),l.p.copy(r).multiplyScalar(u).add(i),void 0!==l.g&&(0===m&&e.value(l.p,o.ValueGrad,this.eval_res),l.g.copy(this.eval_res.g))},u.dichotomy1D=function(e,i,r,s,n,h,a,c){var p=(new t.Vector3).copy(i),l=new t.Vector3,u=-(s/=2),_=u;i.sub(l.copy(r).multiplyScalar(s));for(var v=0;s>h&&v<a;)v++,p.copy(i),_=u,s/=2,e.value(i,o.Value,this.eval_res),this.eval_res.v<n?(i.add(l.copy(r).multiplyScalar(s)),u+=s):(i.sub(l.copy(r).multiplyScalar(s)),u-=s);c.p.copy(i.add(p).divideScalar(2)),c.p_absc=(_+u)/2,c.p.copy(i),c.p_absc=u,c.g&&(e.value(c.p,o.Grad,this.eval_res),c.g.copy(this.eval_res.g))};var _=u,v=function(e,i,r){this.color=new t.Color(null!=e?e:11184810),this.roughness=i||0,this.metalness=r||0};v.prototype.toJSON=function(){return{color:"#"+this.color.getHexString(),roughness:this.roughness,metalness:this.metalness}},v.fromJSON=function(e){return new v(new t.Color(e.color),e.roughness,e.metalness)},v.prototype.clone=function(){return new v(this.color,this.roughness,this.metalness)},v.prototype.copy=function(t){this.color.copy(t.color),this.roughness=t.roughness,this.metalness=t.metalness},v.prototype.set=function(t,e,i){this.color.copy(t),this.roughness=e,this.metalness=i},v.prototype.getColor=function(){return this.color},v.prototype.getRoughness=function(){return this.roughness},v.prototype.getMetalness=function(){return this.metalness},v.prototype.equals=function(t){return this.color.equals(t.color)&&this.metalness===t.metalness&&this.roughness===t.roughness},v.prototype.lerp=function(t,e){this.color.lerp(t.color,e),this.roughness=(1-e)*this.roughness+e*t.roughness,this.metalness=(1-e)*this.metalness+e*t.metalness},v.prototype.triMean=function(t,e,i,r,s,o,n){return this.color.r=(r*t.color.r+s*e.color.r+o*i.color.r)/n,this.color.g=(r*t.color.g+s*e.color.g+o*i.color.g)/n,this.color.b=(r*t.color.b+s*e.color.b+o*i.color.b)/n,this.roughness=(r*t.roughness+s*e.roughness+o*i.roughness)/n,this.metalness=(r*t.metalness+s*e.metalness+o*i.metalness)/n,this},v.prototype.weightedMean=function(t,e,i){this.color.setRGB(0,0,0),this.roughness=0,this.metalness=0;for(var r=void 0===i?t.length:i,s=0,o=0;o<r;++o)this.color.r+=e[o]*t[o].color.r,this.color.g+=e[o]*t[o].color.g,this.color.b+=e[o]*t[o].color.b,this.roughness+=e[o]*t[o].roughness,this.metalness+=e[o]*t[o].metalness,s+=e[o];return 0!==s?(this.color.r/=s,this.color.g/=s,this.color.b/=s,this.roughness/=s,this.metalness/=s):(this.color.r=0,this.color.g=0,this.color.b=0,this.roughness=0,this.metalness=0),this},v.fromJSON=function(e){return new v(new t.Color(parseInt(json_data.c,16)),json_data.r,json_data.m)},v.prototype.getJSON=function(){return{c:function(t){for(var e=t.toString(16),i=6-e.length,r=0;r<i;++r)e="0"+e;return"0x"+e}(this.color.getHex()),r:this.roughness,m:this.metalness}},v.areEqualsArrays=function(t,e,i,r,s){console.warn("Material.areEqualsArrays is deprecated, please use your own comparison function using Material.equals.");for(var o=!0,n=1;n<arguments.length;n++)o=o&&(null===t&&null===arguments[n]||null!==t&&null!==arguments[n]);if(!o)return o;if(null===t)return!0;for(n=1;n<arguments.length;n++){var h=!0;if(arguments[n].length!==t.length)return!1;for(var a=0;a<t.length;++a)h=h&&t[a].equals(arguments[n][a]);o=o&&h}return o},v.defaultMaterial=new v;var m=v,g=function(e,i){if(l.call(this),this.ricci_n=e,i){var r=this;i.forEach(function(t){r.addChild(t)})}this.tmp_res={v:0,g:new t.Vector3(0,0,0),m:new m(null,null,null)},this.tmp_v_arr=new Float32Array(0),this.tmp_m_arr=new Array(0)};(g.prototype=Object.create(l.prototype)).constructor=g,g.type="RicciNode",s.register(g.type,g),g.prototype.getType=function(){return g.type},g.prototype.toJSON=function(){var t=l.prototype.toJSON.call(this);return t.ricci=this.ricci_n,t},g.fromJSON=function(t){for(var e=new g(t.ricci),i=0;i<t.children.length;++i)e.addChild(s.fromJSON(t.children[i]));return e},g.prototype.prepareForEval=function(){if(!this.valid_aabb){this.aabb=new t.Box3;for(var e=0;e<this.children.length;++e){var i=this.children[e];i.prepareForEval(),this.aabb.union(i.getAABB())}if(this.valid_aabb=!0,this.tmp_v_arr.length<this.children.length){this.tmp_v_arr=new Float32Array(2*this.children.length),this.tmp_m_arr.length=2*this.children.length;for(e=0;e<this.tmp_m_arr.length;++e)this.tmp_m_arr[e]=new m(null,0,0)}}},g.prototype.value=function(t,e,i){var r=this.children.length,s=this.tmp_res;if(i.v=0,e&o.Mat&&i.m.copy(m.defaultMaterial),e&o.Grad?i.g.set(0,0,0):e&o.NextStep&&(i.step=1e9),this.aabb.containsPoint(t)&&0!==r){for(var n=this.tmp_v_arr,h=this.tmp_m_arr,a=0,c=0,p=0;p<r;++p)if(this.children[p].aabb.containsPoint(t))if(this.children[p].value(t,e,s),this.countEval++,s.v>0){var l=Math.pow(s.v,this.ricci_n-1);c+=s.v*l,e&o.Grad&&(s.g.multiplyScalar(l),i.g.add(s.g)),e&o.Mat&&(n[a]=s.v*l,h[a].copy(s.m),a++),e&(o.NextStep|o.NextStepOrtho)&&(i.step=Math.min(i.step,this.children[p].heuristicStepWithin()))}else this.countEval0++,e&o.NextStep&&(i.step=Math.min(i.step,this.children[p].distanceTo(t)));else if(e&o.NextStep)i.step=Math.min(i.step,this.children[p].distanceTo(t));else if(e&o.NextStepOrtho){var u;e&o.NextStepZ?u=this.children[p].aabb.min.z-t.z:e&o.NextStepY?u=this.children[p].aabb.min.y-t.y:e&o.NextStepX&&(u=this.children[p].aabb.min.x-t.x),u>0&&(i.step=Math.min(i.step,u))}i.v=Math.pow(c,1/this.ricci_n),0!==i.v&&(e&o.Grad&&i.g.multiplyScalar(i.v/c),e&o.Mat&&i.m.weightedMean(h,n,a))}else e&o.NextStep&&(i.step=this.aabb.distanceToPoint(t)+.3)},g.prototype.setRicciN=function(t){this.ricci_n!=t&&(this.ricci_n=t,this.invalidAABB())},g.prototype.getRicciN=function(){return this.ricci_n};var y,d,f,b,x,w,V,S,A=g,M=function(){A.call(this,64),this.valid_aabb=!0,this.iso_value=1,this.trimmed=[],this.trim_parents=[]};(M.prototype=Object.create(A.prototype)).constructor=M,M.type="RootNode",s.register(M.type,M),M.prototype.getType=function(){return M.type},M.prototype.toJSON=function(){var t=A.prototype.toJSON.call(this);return t.iso=this.iso_value,t},M.fromJSON=function(t){for(var e=new M(t.ricci),i=0;i<t.children.length;++i)e.addChild(s.fromJSON(t.children[i]));return e},M.prototype.getIsoValue=function(){return this.iso_value},M.prototype.setIsoValue=function(t){this.iso_value=t},M.prototype.getNeutralValue=function(){return 0},M.prototype.invalidAABB=function(){this.valid_aabb=!1},M.prototype.internalTrim=function(t){if(0!==this.trimmed.length||0!==this.trim_parents.length)throw"Error : you should not call internal trim if you have not untrimmed before. Call untrim or use externalTrim";this.trim(t,this.trimmed,this.trim_parents)},M.prototype.externalTrim=function(t,e,i){this.trim(t,e,i)},M.prototype.internalUntrim=function(){this.untrim(this.trimmed,this.trim_parents),this.trimmed.length=0,this.trim_parents.length=0},M.prototype.untrim=function(t,e){if(t.length!==e.length)throw"Error : trimmed and parents arrays should have the same length";for(var i=0;i<t.length;++i)e[i].addChild(t[i])},M.prototype.isEmpty=function(){return 0==this.children.length},M.prototype.intersectRayBlob=(y=new t.Vector3,d=new t.Vector3,f=new t.Vector3,b={g:new t.Vector3},x={p:new t.Vector3,g:new t.Vector3,p_absc:0},w=0,V=0,S=0,function(t,e,i,r){for(y.copy(t.origin),d.copy(t.direction),d.normalize(),S=0,this.value(y,EvalTags.Value|EvalTags.NextStep,b);b.v<void 0&&S<i;)y.add(f.copy(d).multiplyScalar(b.step)),S+=b.step,w=b.step,V=b.v,this.value(y,EvalTags.Value|EvalTags.NextStep,b);return b.v>=void 0&&(Convergence.safeNewton1D(this,y,d.multiplyScalar(-1),0,w,w*(void 0-b.v)/(V-b.v),void 0,w/512,10,x),e.distance=S-x.absc,e.point=x.p.clone(),e.g&&e.g.copy(x.g),!0)}),M.prototype.intersectOrthoRayBlob=function(){var e=new t.Vector3,i=new t.Vector3,r={},s={};s.g=new t.Vector3;var o=0,n=0,h=-1;return function(t,a,c,p){for(p.axis&EvalTags.NextStepZ?e.set(this.aabb.min.x+t,this.aabb.min.y+a,this.aabb.min.z+1e-7):p.axis&EvalTags.NextStepY?e.set(this.aabb.min.x+t,this.aabb.min.y+1e-7,this.aabb.min.z+a):p.axis&EvalTags.NextStepX&&e.set(this.aabb.min.x+1e-7,this.aabb.min.y+t,this.aabb.min.z+a),r.step=p.get(this.aabb.max)-p.get(this.aabb.min),this.value(e,EvalTags.Value|p.axis,r),o=1e-7,h=-1;p.get(e)<p.get(this.aabb.max);){for(;(r.v-1)*h>=0&&p.get(e)<p.get(this.aabb.max);)p.add(e,r.step),o=r.step,r.step=p.get(this.aabb.max)-p.get(e),this.value(e,EvalTags.Value|p.axis,r);if(p.get(e)<p.get(this.aabb.max)){for(h*=-1,i.copy(e),n=p.get(e),o/=2,p.add(e,-o);o>.1;)n=p.get(e),o/=2,this.value(e,EvalTags.Value,s),(s.v-1)*h<0?p.add(e,o):p.add(e,-o);p.add(e,n),p.divide(e,2),this.value(e,EvalTags.Grad,s),c.push({point:e.clone(),gradient:s.g.clone()}),e.copy(i)}}}}();var T=M,N=function(e,i,r){l.call(this),this.addChild(e),this.addChild(i),this.alpha=r||1,this.clamped=0,this.tmp_res0={v:0,g:new t.Vector3(0,0,0),m:new m(null,null,null)},this.tmp_res1={v:0,g:new t.Vector3(0,0,0),m:new m(null,null,null)},this.tmp_v_arr=new Float32Array(2),this.tmp_m_arr=[null,null]};(N.prototype=Object.create(l.prototype)).constructor=N,N.type="DifferenceNode",s.register(N.type,N),N.prototype.toJSON=function(){var t=l.prototype.toJSON.call(this);return t.alpha=this.alpha,t},N.fromJSON=function(t){var e=new N;return this.children[0]=s.fromJSON(t.children[0]),this.children[1]=s.fromJSON(t.children[1]),e},N.prototype.prepareForEval=function(){this.valid_aabb||(this.children[0].prepareForEval(),this.children[1].prepareForEval(),this.aabb.copy(this.children[0].getAABB()),this.valid_aabb=!0)},N.prototype.value=function(t,e,i){this.children.length;var r=this.tmp_res0,s=this.tmp_res1,n=this.tmp_v_arr,h=this.tmp_m_arr;if(i.v=0,s.v=0,e&o.Mat&&(i.m.copy(m.defaultMaterial),s.m.copy(m.defaultMaterial)),e&o.Grad?(i.g.set(0,0,0),s.g.set(0,0,0)):e&o.NextStep&&(i.step=1e9),this.aabb.containsPoint(t)){if(this.children[0].aabb.containsPoint(t))if(this.children[0].value(t,e,r),this.children[1].aabb.containsPoint(t)&&this.children[1].value(t,e,s),0===s.v)i.v=r.v,e&o.Grad&&i.g.copy(r.g),e&o.Mat&&i.m.copy(r.m);else{var a=Math.pow(s.v,this.alpha);i.v=Math.max(this.clamped,r.v-s.v*Math.pow(s.v,this.alpha-1)),e&o.Grad&&(i.v===this.clamped?i.g.set(0,0,0):(s.g.multiplyScalar(a),i.g.subVectors(r.g,s.g))),e&o.Mat&&(n[0]=r.v,n[1]=s.v,h[0]=r.m,h[1]=s.m,i.m.weightedMean(h,n,2))}}else e&o.NextStep&&(i.step=this.aabb.distanceToPoint(t)+.3)},N.prototype.trim=function(t,e,i){for(var r=0;r<this.children.length;r++)this.children[r].trim(t,e,i)};var k=N,P=function(e){if(l.call(this),e){var i=this;e.forEach(function(t){i.addChild(t)})}this.tmp_res={v:0,g:new t.Vector3(0,0,0),m:new m(null,null,null)}};(P.prototype=Object.create(l.prototype)).constructor=P,P.type="MinNode",s.register(P.type,P),P.prototype.getType=function(){return P.type},P.fromJSON=function(t){for(var e=new P,i=0;i<t.children.length;++i)e.addChild(s.fromJSON(t.children[i]));return e},P.prototype.prepareForEval=function(){if(!this.valid_aabb){this.aabb=new t.Box3;for(var e=0;e<this.children.length;++e){var i=this.children[e];i.prepareForEval(),this.aabb.union(i.getAABB())}this.valid_aabb=!0}},P.prototype.value=function(t,e,i){var r=this.children.length,s=this.tmp_res;if(i.v=0,e&o.Mat&&i.m.copy(m.defaultMaterial),e&o.Grad?i.g.set(0,0,0):e&o.NextStep&&(i.step=1e9),this.aabb.containsPoint(t)&&0!==r){i.v=Number.MAX_VALUE;for(var n=0;n<r;++n){if(this.children[n].value(t,e,s),this.countEval++,s.v<i.v&&(i.v=s.v,e&o.Grad&&i.g.copy(s.g),e&o.Mat&&i.m.copy(s.m),e&(o.NextStep|o.NextStepOrtho)))throw"Not implemented";i.v=Math.min(i.v,s.v)}}else if(e&o.NextStep)throw"Not implemented"},P.prototype.trim=function(t,e,i){for(var r=0;r<this.children.length;r++)this.children[r].trim(t,e,i)};var B=P,F=function(){a.call(this),this.materials=[]};(F.prototype=Object.create(a.prototype)).constructor=F,F.type="Primitive",s.register(F.type,F),F.prototype.toJSON=function(t){var e=a.prototype.toJSON.call(this);e.materials=[];for(var i=0;i<this.materials.length;++i)e.materials.push(this.materials[i].toJSON());return e},F.prototype.setMaterials=function(t){if(t.length!==this.materials.length)throw"Error : trying to set "+t.length+" materials on a primitive with only "+this.materials.length;for(var e=0;e<t.length;++e)t[e].equals(this.materials[e])||(this.materials[e].copy(t[e]),this.invalidAABB())},F.prototype.getMaterials=function(){return this.materials},F.prototype.computeAABB=function(){throw"Primitive.prototype.computeAABB  Must be reimplemented in all inherited class."},F.prototype.destroy=function(){null!==this.parentNode&&this.parentNode.removeChild(this)},F.prototype.getAreas=function(){throw"ERROR : getAreas is an abstract function, should be re-implemented in all primitives(error occured in "+this.getType()+" primitive)"},F.prototype.computeHelpVariables=function(){throw"ERROR : computeHelpVariables is a virtual function, should be re-implemented in all primitives(error occured in "+this.getType()+" primitive)"},F.prototype.count=function(t){return this instanceof t?1:0};var D=F,O=function(){D.call(this),this.volType=O.DIST,this.v=[]};O.DIST="dist",O.CONVOL="convol",O.prototype=Object.create(D.prototype),O.prototype.constructor=O,O.type="ScalisPrimitive",s.register(O.type,O),O.prototype.getType=function(){return O.type},O.prototype.toJSON=function(){var t=D.prototype.toJSON.call(this);t.v=[],t.volType=this.volType;for(var e=0;e<this.v.length;++e)t.v.push(this.v[e].toJSON());return t},O.prototype.mutableVolType=function(){return!1},O.prototype.setVolType=function(t){t!==this.volType&&(this.volType=t,this.invalidAABB())},O.prototype.getVolType=function(){return this.volType},O.prototype.setVPos=function(t,e){if(t>=this.v.length)throw"ScalisVertex index invalid";this.v[t].setPos(e),this.invalidAABB()},O.prototype.setVThickness=function(t,e){if(t>=this.v.length)throw"ScalisVertex index invalid";this.v[t].setThickness(e),this.invalidAABB()},O.prototype.setVAll=function(t,e,i){if(t>=this.v.length)throw"ScalisVertex index invalid";this.v[t].setAll(e,i),this.invalidAABB()},O.prototype.getVPos=function(t,e){return this.v[t].getPos()},O.prototype.getVThickness=function(t){return this.v[t].getThickness()},O.prototype.computeAABB=function(){this.aabb.makeEmpty();for(var t=0;t<this.v.length;t++)this.aabb.union(this.v[t].getAABB())};var z=O,E={KS:2,KS2:4};E.KIS2=1/(E.KS*E.KS),E.Poly6Eval=function(t){var e=1-E.KS2*t*t;return e>0?e*e*e:0},E.Poly6EvalSq=function(t){var e=1-E.KS2*t;return e>0?e*e*e:0},E.GetIsoValueAtDistanceGeom0D=function(t,e,i){if(t%2!=0)throw"degree should be even";if(i<e){var r=1-i*i/(e*e);return Math.pow(r,t/2)}return 0},E.Poly4NF0D=1/E.GetIsoValueAtDistanceGeom0D(4,E.KS,1),E.Poly6NF0D=1/E.GetIsoValueAtDistanceGeom0D(6,E.KS,1),E.GetIsoValueAtDistanceGeom1D=function(t,e,i){if(t%2!=0)throw"degree should be even";if(i<e){for(var r=1-i*i/(e*e),s=2*e*Math.sqrt(r),o=0;o!=t;)s*=(o+=2)/(1+o)*r;return s}return 0},E.Poly4NF1D=1/E.GetIsoValueAtDistanceGeom1D(4,E.KS,1),E.Poly6NF1D=1/E.GetIsoValueAtDistanceGeom1D(6,E.KS,1),E.GetIsoValueAtDistanceGeom2D=function(t,e,i){if(i<e){var r=t+2,s=1-i*i/(e*e);return 2*Math.PI/r*e*e*Math.pow(s,.5*r)}return 0},E.Poly4NF2D=1/E.GetIsoValueAtDistanceGeom2D(4,E.KS,1),E.Poly6NF2D=1/E.GetIsoValueAtDistanceGeom2D(6,E.KS,1);var q=E,j=0,R=function(e,i){this.pos=e,this.thickness=i,this.id=j++,this.aabb=new t.Box3,this.valid_aabb=!1};R.prototype.toJSON=function(){return{position:{x:this.pos.x,y:this.pos.y,z:this.pos.z},thickness:this.thickness}},R.fromJSON=function(e){return new R(new t.Vector3(e.position.x,e.position.y,e.position.z),e.thickness)},R.prototype.setPos=function(t){this.valid_aabb=!1,this.pos=t},R.prototype.setThickness=function(t){this.valid_aabb=!1,this.thickness=t},R.prototype.setAll=function(t,e){this.valid_aabb=!1,this.pos=t,this.thickness=e},R.prototype.getPos=function(){return this.pos},R.prototype.getThickness=function(){return this.thickness},R.prototype.getAABB=function(){return this.valid_aabb||(this.computeAABB(),this.valid_aabb=!0),this.aabb},R.prototype.computeAABB=function(){var e=this.getPos(),i=this.getThickness()*q.KS;this.aabb.set(new t.Vector3(e.x-i,e.y-i,e.z-i),new t.Vector3(e.x+i,e.y+i,e.z+i))},R.prototype.equals=function(t){return this.pos.equals(t.pos)&&this.thickness===t.thickness};var C=R,I=function(){};I.prototype.sphereIntersect=function(t){throw"Error : sphereIntersect is abstract, should have been overwritten"},I.prototype.contains=function(t){throw"Error : contains is abstract, should have been overwritten"},I.prototype.getAcc=function(t,e){throw"Error : getAcc is abstract, should have been overwritten"},I.prototype.getNiceAcc=function(t){throw"Error : getNiceAcc is abstract, should have been overwritten"},I.prototype.getCurrAcc=function(t){throw"Error : getCurrAcc is abstract, should have been overwritten"},I.prototype.getRawAcc=function(t){throw"Error : getRawAcc is abstract, should have been overwritten"},I.prototype.getMinAcc=function(){throw"Error : getRawAcc is abstract, should have been overwritten"},I.prototype.getMinRawAcc=function(){throw"Error : getRawAcc is abstract, should have been overwritten"};var J=I,G={nice:.3,raw:1,curr:.3},K=G,H=function(e,i){J.call(this),this.p=new t.Vector3(e.x,e.y,e.z),this.thick=i,this.v_to_p=new t.Vector3};(H.prototype=Object.create(J.prototype)).constructor=H,H.prototype.sphereIntersect=function(t){this.v_to_p.subVectors(t.center,this.p);var e=t.radius+this.thick*q.KS;return this.v_to_p.lengthSq()<e*e},H.prototype.contains=function(t){return this.v_to_p.subVectors(t,this.p),this.v_to_p.lengthSq()<this.thick*this.thick*q.KS2},H.prototype.getAcc=function(t,e){return this.thick*e},H.prototype.getNiceAcc=function(t){return this.getAcc(t,K.nice)},H.prototype.getCurrAcc=function(t){return this.getAcc(t,K.curr)},H.prototype.getRawAcc=function(t){return this.getAcc(t,K.raw)},H.prototype.getMinAcc=function(){return K.curr*this.thick},H.prototype.getMinRawAcc=function(){return K.raw*this.thick},H.prototype.getAxisProjectionMinStep=function(t,e){var i=1e8,r=e-this.p[t];return r<-2*this.thick?i=Math.min(i,Math.max(Math.abs(r+2*this.thick),K.curr*this.thick)):r<2*this.thick&&(i=Math.min(i,K.curr*this.thick)),i};var L=H,U=function(e,i,r,s){z.call(this),this.v.push(e),this.volType=z.DIST,this.density=r,this.materials.push(s),this.v_to_p=new t.Vector3};(U.prototype=Object.create(z.prototype)).constructor=U,U.type="ScalisPoint",s.register(U.type,U),U.prototype.getType=function(){return U.type},U.prototype.toJSON=function(){var t=z.prototype.toJSON.call(this);return t.density=this.density,t},U.fromJSON=function(t){var e=C.fromJSON(t.v[0]),i=m.fromJSON(t.materials[0]);return new U(e,t.volType,t.density,i)},U.prototype.setDensity=function(t){this.density=t,this.invalidAABB()},U.prototype.getDensity=function(){return this.density},U.prototype.setMaterial=function(t){this.materials[0].copy(t),this.invalidAABB()},U.prototype.computeHelpVariables=function(){this.computeAABB()},U.prototype.prepareForEval=function(){this.valid_aabb||(this.computeHelpVariables(),this.valid_aabb=!0)},U.prototype.getAreas=function(){if(this.valid_aabb)return[{aabb:this.aabb,bv:new L(this.v[0].getPos(),this.v[0].getThickness()),obj:this}];throw"ERROR : Cannot get area of invalid primitive"},U.prototype.heuristicStepWithin=function(){return this.v[0].getThickness()/3},U.prototype.value=function(t,e,i){if(!this.valid_aabb)throw"Error : PrepareForEval should have been called";var r=this.v[0].getThickness();this.v_to_p.subVectors(t,this.v[0].getPos());var s=this.v_to_p.lengthSq()/(r*r),n=1-q.KIS2*s;if(n>0){if(i.v=this.density*n*n*n*q.Poly6NF0D,e&o.Grad){var h=-this.density*q.KIS2*6*this.v_to_p.length()*n*n*q.Poly6NF0D/(r*r);i.g.copy(this.v_to_p).normalize().multiplyScalar(h)}e&o.Mat&&i.m.copy(this.materials[0])}else i.v=0,e&o.Grad&&i.g.set(0,0,0),e&o.Mat&&i.m.copy(m.defaultMaterial)},U.prototype.distanceTo=function(t){return t.distanceTo(this.v[0].getPos())};var W=U,Z=function(e,i,r,s){J.call(this),this.p0=new t.Vector3(e.x,e.y,e.z),this.p1=new t.Vector3(i.x,i.y,i.z),this.thick0=r,this.thick1=s,this.unit_dir=(new t.Vector3).subVectors(p2,p2),this.length=this.unit_dir.length(),this.unit_dir.normalize(),this.vector=new t.Vector3,this.p0_to_p=this.vector,this.p0_to_p_sqrnorm=0,this.x_p_2D=0,this.y_p_2D=0,this.y_p_2DSq=0,this.ortho_vec_x=this.thick0-this.thick1,this.ortho_vec_y=this.length,this.p_proj_x=0,this.p_proj_y=0,this.abs_diff_thick=Math.abs(this.ortho_vec_x)};(Z.prototype=Object.create(J.prototype)).constructor=Z,Z.prototype.proj_computation=function(t){this.p0_to_p=this.vector,this.p0_to_p.subVectors(t,this.p0),this.p0_to_p_sqrnorm=this.p0_to_p.lengthSq(),this.x_p_2D=this.p0_to_p.dot(this.unit_dir),this.y_p_2DSq=this.p0_to_p_sqrnorm-this.x_p_2D*this.x_p_2D,this.y_p_2D=this.y_p_2DSq>0?Math.sqrt(this.y_p_2DSq):0;var e=-this.y_p_2D/this.ortho_vec_y;this.p_proj_x=this.x_p_2D+e*this.ortho_vec_x,this.p_proj_y=0},Z.prototype.sphereIntersect=function(t){if(this.proj_computation(t.center),this.p_proj_x<0)return Math.sqrt(this.p0_to_p_sqrnorm)-t.radius<this.thick0*q.KS;if(this.p_proj_x>this.length)return this.vector.subVectors(t.center,this.p1),Math.sqrt(this.vector.lengthSq())-t.radius<this.thick1*q.KS;var e=this.x_p_2D-this.p_proj_x,i=e*e+this.y_p_2DSq,r=this.p_proj_x/this.length,s=this.thick0*(1-r)+r*this.thick1,o=t.radius+s*q.KS;return i<o*o},Z.prototype.contains=function(t){if(this.proj_computation(t),this.p_proj_x<0)return this.p0_to_p_sqrnorm<this.thick0*this.thick0*q.KS2;if(this.p_proj_x>this.length)return this.vector.subVectors(t,this.p1),this.vector.lengthSq()<this.thick1*this.thick1*q.KS2;var e=this.x_p_2D-this.p_proj_x,i=this.y_p_2D-this.p_proj_y,r=e*e+i*i,s=this.p_proj_x/this.length,o=this.thick0*(1-s)+s*this.thick1;return r<o*o*q.KS2},Z.prototype.getAcc=function(t,e){this.proj_computation(t.center);var i=this.abs_diff_thick/this.length,r=t.radius*Math.sqrt(1+i*i)*.5,s=this.p_proj_x;if((s+=this.thick0>this.thick1?r:-r)<0)return this.thick0*e;if(s>this.length)return this.thick1*e;var o=s/this.length;return(this.thick0*(1-o)+o*this.thick1)*e},Z.prototype.getNiceAcc=function(t){return this.getAcc(t,K.nice)},Z.prototype.getCurrAcc=function(t){return this.getAcc(t,K.curr)},Z.prototype.getRawAcc=function(t){return this.getAcc(t,K.raw)},Z.prototype.getMinAcc=function(){return K.curr*Math.min(this.thick0,this.thick1)},Z.prototype.getMinRawAcc=function(){return K.raw*Math.min(this.thick0,this.thick1)},Z.prototype.getAxisProjectionMinStep=function(t,e){var i,r,s,o=Number.MAX_VALUE,n=this.p0[t]<this.p1[t]?this.p0:this.p1;n===this.p0?(i=this.p1,r=this.thick0,s=this.thick1):(i=this.p0,r=this.thick1,s=this.thick0);var h=e-n[t];h<-2*r?o=Math.min(o,Math.max(Math.abs(h+2*r),K.curr*r)):h<2*r&&(o=Math.min(o,K.curr*r)),(h=e-i[t])<-2*s?o=Math.min(o,Math.max(Math.abs(h+2*s),K.curr*s)):h<2*s&&(o=Math.min(o,K.curr*s));var a=e-n[t],c=i[t]-n[t];return a>0&&a<c&&0!==c&&(o=Math.min(o,K.curr*(r+a/c*(s-r)))),o};var X,Y,Q=Z,$=function(e,i,r,s,o){z.call(this),this.v.length=2,this.v[0]=e,this.v[1]=i,this.volType=r,this.density=s,this.materials=o,this.clipped_l1=1,this.clipped_l2=0,this.vector=new t.Vector3,this.cycle=new t.Vector3,this.proj=new t.Vector3,this.ev_eps={v:0},this.p_eps=new t.Vector3,this.v0_p=this.v[0].getPos(),this.v1_p=this.v[1].getPos(),this.dir=new t.Vector3,this.lengthSq=0,this.length=0,this.unit_dir=new t.Vector3,this.weight_p1=0,this.c0=0,this.c1=0,this.increase_unit_dir=new t.Vector3,this.p_min=new t.Vector3,this.weight_min=0,this.inv_weight_min=0,this.unit_delta_weight=0,this.maxbound=0,this.maxboundSq=0,this.cyl_bd0=0,this.cyl_bd1=0,this.f0f1f2=new t.Vector3,this.tmpVec1=new t.Vector3,this.tmpVec2=new t.Vector3,this.computeHelpVariables()};$.prototype=Object.create(z.prototype),$.constructor=$,$.type="ScalisSegment",s.register($.type,$),$.prototype.getType=function(){return $.type},$.prototype.toJSON=function(){var t=z.prototype.toJSON.call(this);return t.density=this.density,t},$.fromJSON=function(t){var e=C.fromJSON(t.v[0]),i=C.fromJSON(t.v[1]),r=[m.fromJSON(t.materials[1]),m.fromJSON(t.materials[1])];return new $(e,i,t.volType,t.density,r)},$.prototype.mutableVolType=function(){return!0},$.prototype.setDensity=function(t){this.density=t,this.invalidAABB()},$.prototype.getDensity=function(){return this.density},$.prototype.setVolType=function(t){if(t!=z.CONVOL&&t!=z.DIST)throw"ERROR : volType must be set to ScalisPrimitive.CONVOL or ScalisPrimitive.DIST";this.volType!=t&&(this.volType=t,this.invalidAABB())},$.prototype.getVolType=function(){return this.volType},$.prototype.prepareForEval=function(){return this.valid_aabb||(this.computeHelpVariables(),this.valid_aabb=!0),res},$.prototype.getAreas=function(){if(this.valid_aabb)return[{aabb:this.aabb,bv:new Q(this.v[0].getPos(),this.v[1].getPos(),this.v[0].getThickness(),this.v[1].getThickness(),this.length,this.unit_dir),obj:this}];throw"ERROR : Cannot get area of invalid primitive"},$.prototype.computeHelpVariables=function(){this.v0_p=this.v[0].getPos(),this.v1_p=this.v[1].getPos(),this.dir.subVectors(this.v1_p,this.v0_p),this.lengthSq=this.dir.lengthSq(),this.length=Math.sqrt(this.lengthSq),this.unit_dir.copy(this.dir).normalize(),this.weight_p1=this.v[1].getThickness(),this.c0=this.v[0].getThickness(),this.c1=this.v[1].getThickness()-this.v[0].getThickness();var t=this.v[0].getThickness()*q.KS,e=this.v[1].getThickness()*q.KS;this.maxbound=Math.max(t,e),this.maxboundSq=this.maxbound*this.maxbound,this.cyl_bd0=Math.min(-t,this.length-e),this.cyl_bd1=Math.max(this.length+e,t),this.increase_unit_dir.copy(this.unit_dir),this.c1<0?(this.p_min.copy(this.v1_p),this.weight_min=this.weight_p1,this.inv_weight_min=1/this.weight_p1,this.increase_unit_dir.negate(),this.unit_delta_weight=-this.c1/this.length):(this.p_min.copy(this.v0_p),this.weight_min=this.c0,this.inv_weight_min=1/this.c0,this.unit_delta_weight=this.c1/this.length),this.computeAABB()},$.prototype.value=function(t,e,i){switch(this.volType){case z.DIST:this.evalDist(t,e,i);break;case z.CONVOL:this.evalConvol(t,e,i);break;default:throw"Unknown volType, cannot evaluate."}},$.prototype.evalDist=function(t,e,i){var r=this.vector;r.subVectors(t,this.v[0].getPos());var s=r.dot(this.dir),n=r.lengthSq(),h=this.lengthSq*this.c0+s*this.c1,a=this.c1<0?0:1;h>0&&(a=(a=s*this.c0+n*this.c1)<0?0:a>h?1:a/h);var c=Math.sqrt(a*(a*this.lengthSq-2*s)+n),p=this.c0+a*this.c1;if(i.v=this.density*q.Poly6Eval(c/p)*q.Poly6NF0D,e&o.Mat&&this.evalMat(t,i),e&o.Grad){var l=this.density/1e-5;this.p_eps.copy(t),this.p_eps.x+=1e-5,this.evalDist(this.p_eps,o.Value,this.ev_eps),i.g.x=l*(this.ev_eps.v-i.v),this.p_eps.x-=1e-5,this.p_eps.y+=1e-5,this.evalDist(this.p_eps,o.Value,this.ev_eps),i.g.y=l*(this.ev_eps.v-i.v),this.p_eps.y-=1e-5,this.p_eps.z+=1e-5,this.evalDist(this.p_eps,o.Value,this.ev_eps),i.g.z=l*(this.ev_eps.v-i.v)}},$.prototype.evalMat=function(t,e){var i=this.vector;i.subVectors(t,this.v[0].getPos());var r=this.unit_dir.dot(i)/this.length;r>1?e.m.copy(this.materials[1]):r<=0?e.m.copy(this.materials[0]):(e.m.copy(this.materials[0]),e.m.lerp(this.materials[1],r))},$.prototype.HomotheticClippingSpecial=function(t){var e=-t.z,i=-t.y,r=-t.x,s=i*i-e*r;if(s>=0){var o=i+Math.sqrt(s);if(o<0||this.length*o<r)return!1;var n=r/o;this.clipped_l1=n<0?0:n;var h=e*n;return this.clipped_l2=2*i<h+e*this.length?r/h:this.length,!0}return!1},$.prototype.heuristicStepWithin=function(){return this.weight_min/3},$.prototype.evalConvol=function(t,e,i){if(!this.valid_aabb)throw"Error : prepareForEval should have been called";e&o.Grad&&i.g.set(0,0,0),i.v=0;var r=this.tmpVec1;r.subVectors(t,this.p_min);var s=this.increase_unit_dir.dot(r),n=r.lengthSq(),h=this.tmpVec2;if(h.set(this.weight_min*this.weight_min-q.KIS2*n,-this.unit_delta_weight*this.weight_min-q.KIS2*s,this.unit_delta_weight*this.unit_delta_weight-q.KIS2),this.HomotheticClippingSpecial(h)){var a=1/(this.weight_min+this.clipped_l1*this.unit_delta_weight);h.x=1-q.KIS2*(this.clipped_l1*(this.clipped_l1-2*s)+n)*a*a,h.y=-this.unit_delta_weight-q.KIS2*(s-this.clipped_l1)*a,e&o.Grad?(this.unit_delta_weight>=.06?this.HomotheticCompactPolynomial_segment_FGradF_i6((this.clipped_l2-this.clipped_l1)*a,this.unit_delta_weight,h):this.HomotheticCompactPolynomial_approx_segment_FGradF_i6((this.clipped_l2-this.clipped_l1)*a,this.unit_delta_weight,this.inv_weight_min,h),i.v=q.Poly6NF1D*this.f0f1f2.x,this.f0f1f2.y*=a,i.g.copy(this.increase_unit_dir).multiplyScalar(this.f0f1f2.z+this.clipped_l1*this.f0f1f2.y).sub(r.multiplyScalar(this.f0f1f2.y)).multiplyScalar(6*q.Poly6NF1D*q.KIS2*a)):this.unit_delta_weight>=.06?i.v=q.Poly6NF1D*this.HomotheticCompactPolynomial_segment_F_i6((this.clipped_l2-this.clipped_l1)*a,this.unit_delta_weight,h):i.v=q.Poly6NF1D*this.HomotheticCompactPolynomial_approx_segment_F_i6((this.clipped_l2-this.clipped_l1)*a,this.unit_delta_weight,a,h),e&o.Mat&&this.evalMat(t,i)}},$.prototype.clamp=function(t,e,i){return Math.max(e,Math.min(i,t))},$.prototype.distanceTo=(X=new t.Vector3,Y=new t.Vector3,function(t){var e=X.subVectors(t,this.v[0].getPos()).dot(this.dir)/this.lengthSq;return e=this.clamp(e,0,1),Y.copy(this.dir).multiplyScalar(e).add(this.v[0].getPos()),t.distanceTo(Y)}),$.prototype.HomotheticCompactPolynomial_segment_F_i6=function(t,e,i){var r=e*t+1,s=1/r,o=r*r,n=1/(o*o),h=i.y,a=h*h,c=12*a,p=1/e,l=h*p,u=r*o,_=t*t,v=_*_,m=t*_,g=t*v,y=i.x,d=i.z,f=y*y,b=d*d,x=1/(u*u),w=s*n,V=1/u,S=1/o;return-b*(((((-(s-1)*p-t*S)*p-_*V)*p-m*n)*p-v*w)*p-g*x)*l+(-y*(x-1)*p/6-(-(w-1)*p/5-t*x)*l)*f+((y*c+3*d*f)*(.4*(-(n-1)*p/4-t*w)*p-_*x)+(3*b*y+d*c)*(.8*(.75*(2/3*(-(S-1)*p/2-t*V)*p-_*n)*p-m*w)*p-v*x)+d*b*(1.2*(5/4*(4/3*(1.5*(2*(Math.log(r)*p-t*s)*p-_*S)*p-m*V)*p-v*n)*p-g*w)*p-m*m*x)+(-12*d*y-8*a)*(.6*((-(V-1)*p/3-t*n)*p/2-_*w)*p-m*x)*h)*p/6},$.prototype.HomotheticCompactPolynomial_approx_segment_F_i6=function(t,e,i,r){var s=i*e,o=s+1,n=1/o,h=o*o,a=n/(h*h)/h,c=r.z,p=r.y,l=r.x,u=t*t,_=c*u-2*p*t+l,v=c*l-p*p,m=c*t-p,g=l*l,y=p*g,d=_*_,f=m*d,b=1/c,x=v*b,w=6/35*(4/3*(2*v*t+m*_+p*l)*x+f+y)*x+_*f/7+l*y/7,V=b*w,S=n*a,A=d*d,M=p*V+A/8-g*g/8,T=-t*A+(-10*p*M+l*w)*b;return V-7*e*M*b+(-.1111111111*(3*a-3+7*(2+S)*s)*T-.1*(2-2*a-7*(1+S)*s)/i*(-1*u*A+(1.333333333*p*T+2*l*M)*b))*b/(i*i)},$.prototype.HomotheticCompactPolynomial_segment_FGradF_i6=function(t,e,i){var r=e*t+1,s=1/r,o=r*r,n=1/(o*o),h=i.y,a=h*h,c=2*a,p=i.z,l=i.x,u=p*l/3+2/3*a,_=p*p,v=_/6,m=-2/3*p,g=r*o,y=1/g,d=s*n,f=1/(g*g),b=t*t,x=1/e,w=t*b,V=.6*((-(y-1)*x/3-t*n)*x/2-b*d)*x-w*f,S=V*h,A=-(d-1)*x/5-t*f,M=l*l,T=M*A,N=.4*(-(n-1)*x/4-t*d)*x-b*f,k=l*N,P=-M*(f-1)/6,B=b*b,F=t*B,D=1/o,O=.8*(.75*(2/3*(-(D-1)*x/2-t*y)*x-b*n)*x-w*d)*x-B*f,z=((((-(s-1)*x-t*D)*x-b*y)*x-w*n)*x-B*d)*x-F*f,E=w*w,q=Math.log(r);this.f0f1f2.x=(l*P-h*T+k*c-4/3*a*S+(M*N/2+O*c-2*l*S)*p+(l*O/2-h*z+(-E*f/6+(-F*d/5+(-B*n/4+(-w*y/3+(-b*D/2+(q*x-t*s)*x)*x)*x)*x)*x)*p)*_)*x,this.f0f1f2.y=(P+N*u+O*v+(-2/3*l*A+V*m)*h)*x,this.f0f1f2.z=(T/6+V*u+z*v+(-2/3*k+O*m)*h)*x},$.prototype.HomotheticCompactPolynomial_approx_segment_FGradF_i6=function(t,e,i,r){var s=i*e,o=s+1,n=1/o,h=1/(i*i),a=o*o,c=n/(a*a)/a,p=r.x,l=2*p,u=r.z,_=1/u,v=e*_,m=r.y,g=t*t,y=u*g-2*m*t+p,d=y*y,f=y*d,b=p*p,x=p*b,w=u*p-m*m,V=u*t-m,S=w*_,A=4/3*(2*w*t+V*y+m*p)*S+V*d+m*b,M=A/5,T=m*_*M+f/6-x/6,N=-t*f+(-8*m*T+p*M)*_,k=g*f,P=(10/7*m*N+T*l)*_-k,B=-P/8,F=6/35*A*S+V*f/7+m*x/7,D=n*c,O=(3*c-3+7*(2+D)*s)*h,z=(2-2*c-7*(1+D)*s)/i*h,E=_*O,q=_*z,j=_*F,R=d*d,C=m*j+R/8-b*b/8,I=-t*R+(-10*m*C+p*F)*_;this.f0f1f2.x=j-7*C*v-I*E/9-(-g*R+(4/3*m*I+C*l)*_)*q/10,this.f0f1f2.y=(M-7*e*T-N*O/7+z*B)*_,this.f0f1f2.z=T*_+N*v+E*B-(-t*k+(1.5*m*P-3/7*p*N)*_)*q/9};var tt=$,et={},it=function(t,e){var i=t;if(0===e)throw"Lenght of the array should not be null";return 1===e?0:(t<0&&(i=(e+t)%e),t>=e&&(i=t%e),i)};et.computeVectorsDirs=function(e){var i=e.v[0].getPos(),r=e.v[1].getPos(),s=e.v[2].getPos();e.p0p1.subVectors(r,i),e.p1p2.subVectors(s,r),e.p2p0.subVectors(i,s),e.unit_normal.crossVectors(e.p0p1,e.p2p0),e.unit_normal.normalize(),e.length_p0p1=e.p0p1.length(),e.unit_p0p1.copy(e.p0p1),e.unit_p0p1.divideScalar(e.length_p0p1),e.diffThick_p0p1=e.v[0].getThickness()-e.v[1].getThickness(),e.length_p1p2=e.p1p2.length(),e.unit_p1p2.copy(e.p1p2),e.unit_p1p2.divideScalar(e.length_p1p2),e.diffThick_p1p2=e.v[1].getThickness()-e.v[2].getThickness(),e.length_p2p0=e.p2p0.length(),e.unit_p2p0.copy(e.p2p0),e.unit_p2p0.divideScalar(e.length_p2p0),e.diffThick_p2p0=e.v[2].getThickness()-e.v[0].getThickness();var o=[];o.push({vert:e.v[0].getPos(),thick:e.v[0].getThickness(),idx:0}),o.push({vert:e.v[1].getPos(),thick:e.v[1].getThickness(),idx:1}),o.push({vert:e.v[2].getPos(),thick:e.v[2].getThickness(),idx:2}),o.sort(function(t,e){return t.thick-e.thick}),e.point_min=o[0].vert,e.weight_min=o[0].thick;var n=it(o[0].idx+1,3),h=e.v[n].getPos(),a=e.v[n].getThickness();n=it(o[0].idx+2,3);var c=e.v[n].getPos(),p=e.v[n].getThickness(),l=new t.Vector3;l=l.subVectors(h,e.point_min);var u=new t.Vector3;u=u.subVectors(c,e.point_min);var _=a-e.weight_min,v=p-e.weight_min;if(_<1e-6||v<1e-6){if(_<v){e.ortho_dir=l.clone(),e.ortho_dir.normalize(),e.main_dir.crossVectors(e.ortho_dir,e.unit_normal),e.main_dir.normalize(),e.main_dir.dot(u)<0&&e.main_dir.multiplyScalar(-1);var m=-e.weight_min/v;e.point_iso_zero=new t.Vector3(e.point_min.x+m*u.x,e.point_min.y+m*u.y,e.point_min.z+m*u.z)}else{e.ortho_dir=u.clone(),e.ortho_dir.normalize(),e.main_dir.crossVectors(e.ortho_dir,e.unit_normal),e.main_dir.normalize(),e.main_dir.dot(l)<0&&e.main_dir.multiplyScalar(-1);m=-e.weight_min/_;e.point_iso_zero=new t.Vector3(e.point_min.x+m*l.x,e.point_min.y+m*l.y,e.point_min.z+m*l.z)}Math.abs(_-v)<1e-6&&(e.proj_dir=e.unit_normal.clone().multiplyScalar(-1),e.equal_weights=!0)}else{var g=-e.weight_min/_,y=new t.Vector3(e.point_min.x+g*l.x,e.point_min.y+g*l.y,e.point_min.z+g*l.z);e.point_iso_zero=y;var d=-e.weight_min/v,f=new t.Vector3(e.point_min.x+d*u.x,e.point_min.y+d*u.y,e.point_min.z+d*u.z);e.ortho_dir.subVectors(f,y),e.ortho_dir.normalize(),e.main_dir.crossVectors(e.ortho_dir,e.unit_normal),e.main_dir.normalize(),(e.main_dir.dot(l)<0||e.main_dir.dot(u)<0)&&e.main_dir.multiplyScalar(-1)}var b=l.dot(e.main_dir),x=u.dot(e.main_dir),w=null;(b=b<0?0:b)>(x=x<0?0:x)?(w=l,e.half_dir_1=u,e.point_half=c,e.half_dir_2=h.clone().subVectors(h,c),e.coord_max=b,e.coord_middle=x/b*e.coord_max,e.unit_delta_weight=_/e.coord_max):(w=u,e.half_dir_1=l,e.point_half=h,e.half_dir_2=c.clone().subVectors(c,h),e.coord_max=x,e.coord_middle=b/x*e.coord_max,e.unit_delta_weight=v/e.coord_max),e.longest_dir_special=w.divideScalar(e.coord_max);var V=new t.Vector3;V.subVectors(e.half_dir_1,e.longest_dir_special.clone().multiplyScalar(e.coord_middle)),e.max_seg_length=V.length(),e.unsigned_ortho_dir=e.ortho_dir.clone(),e.ortho_dir.dot(V)<0&&e.ortho_dir.multiplyScalar(-1)},et.getParametrisedVertexAttr=function(e,i,r){var s=et.getMeanThick(e,i,r),o=new t.Vector3,n=o.subVectors(e.v[1].getPos(),e.v[0].getPos()).multiplyScalar(i),h=o.clone().subVectors(e.v[2].getPos(),e.v[0].getPos()).multiplyScalar(r);return o.addVectors(e.v[0].getPos(),n),o.addVectors(o,h),{pos:o,thick:s}},et.getMeanThick=function(t,e,i){return t.v[0].getThickness()*(1-e-i)+t.v[1].getThickness()*e+t.v[2].getThickness()*i},et.getMeanMat=function(t,e,i){var r=new Material(null,null,null),s=null===t.materials?[t.v[0].getMaterial(),t.v[0].getMaterial(),t.v[0].getMaterial()]:[t.materials[0],t.materials[1],t.materials[2]];return r.weightedMean(s,[1-e-i,e,i]),r},et.getTriBaryCoord=function(e,i,r,s){var o=e,n=i.clone().multiplyScalar(-1),h=(new t.Vector3).subVectors(s,r),a=o.lengthSq(),c=o.dot(n),p=h.dot(o),l=n.lengthSq(),u=(a*h.dot(n)-c*p)/(a*l-c*c);return{u:(p-u*c)/a,v:u}},et.getUVCoord=function(e,i,r,s){var o=new t.Vector3;o.crossVectors(e,i);var n=new t.Matrix4;n.set(e.x,i.x,o.x,0,e.y,i.y,o.y,0,e.z,i.z,o.z,0,0,0,0,1);var h=new t.Matrix4;h.getInverse(n);var a=(new t.Vector3).subVectors(s,r);return a.applyMatrix4(h),{u:a.x,v:a.y}};var rt=et,st=function(e,i,r,s,o,n){J.call(this),this.tmpVect=new t.Vector3,this.min_thick=o,this.max_thick=n,this.v=e,this.p0p1=this.tmpVect.clone().subVectors(this.v[1].getPos(),this.v[0].getPos()),this.p2p0=this.tmpVect.clone().subVectors(this.v[0].getPos(),this.v[2].getPos()),this.unit_normal=i,this.main_dir=r;var h=Math.abs(this.v[0].getThickness()-this.v[1].getThickness()),a=Math.abs(this.v[1].getThickness()-this.v[2].getThickness());this.equal_weights=h/Math.abs(this.v[0].getThickness()+this.v[1].getThickness())<.001&&a/Math.abs(this.v[1].getThickness()+this.v[2].getThickness())<.001,this.segParams=s,this.segAttr={p0_to_p:0,p0_to_p_sqrnorm:0,x_p_2D:0,y_p_2D:0,y_p_2DSq:0,p_proj_x:0};var c=this.tmpVect.clone().crossVectors(this.segParams[0].dir,this.unit_normal).normalize(),p=this.tmpVect.clone().crossVectors(this.segParams[1].dir,this.unit_normal).normalize(),l=this.tmpVect.clone().crossVectors(this.segParams[2].dir,this.unit_normal).normalize();this.tmpVect.copy(this.unit_normal);var u=[];u.push(this.tmpVect.clone().addVectors(this.v[0].getPos(),this.tmpVect.multiplyScalar(this.v[0].getThickness()*q.KS))),this.tmpVect.copy(this.unit_normal),u.push(this.tmpVect.clone().addVectors(this.v[1].getPos(),this.tmpVect.multiplyScalar(this.v[1].getThickness()*q.KS))),this.tmpVect.copy(this.unit_normal),u.push(this.tmpVect.clone().addVectors(this.v[2].getPos(),this.tmpVect.multiplyScalar(this.v[2].getThickness()*q.KS))),this.tmpVect.copy(this.unit_normal),u.push(this.tmpVect.clone().addVectors(this.v[0].getPos(),this.tmpVect.multiplyScalar(-this.v[0].getThickness()*q.KS))),this.tmpVect.copy(this.unit_normal),u.push(this.tmpVect.clone().addVectors(this.v[1].getPos(),this.tmpVect.multiplyScalar(-this.v[1].getThickness()*q.KS))),this.tmpVect.copy(this.unit_normal),u.push(this.tmpVect.clone().addVectors(this.v[2].getPos(),this.tmpVect.multiplyScalar(-this.v[2].getThickness()*q.KS)));var _=new t.Vector3;this.tmpVect.subVectors(u[1],u[0]),_.subVectors(u[2],u[0]);var v=this.tmpVect.clone().crossVectors(this.tmpVect,_).normalize();this.tmpVect.subVectors(u[5],u[3]),_.subVectors(u[4],u[3]);var m=this.tmpVect.clone().crossVectors(this.tmpVect,_).normalize();this.planeParams=[],this.planeParams.push({orig:this.v[0].getPos(),n:c}),this.planeParams.push({orig:this.v[1].getPos(),n:p}),this.planeParams.push({orig:this.v[2].getPos(),n:l}),this.planeParams.push({orig:u[0],n:v}),this.planeParams.push({orig:u[3],n:m}),this.segAreas=[];for(var g=0;g<3;++g)this.segAreas.push(new AreaSeg(this.segParams[g].v[0].getPos(),this.segParams[g].v[1].getPos(),this.segParams[g].v[0].getThickness(),this.segParams[g].v[1].getThickness(),this.segParams[g].norm,this.segParams[g].dir))};(st.prototype=Object.create(J.prototype)).constructor=st,st.prototype.proj_computation=function(t,e){this.segAttr.p0_to_p=this.tmpVect,this.segAttr.p0_to_p.subVectors(t,e.v[0].getPos()),this.segAttr.p0_to_p_sqrnorm=this.segAttr.p0_to_p.lengthSq(),this.segAttr.x_p_2D=this.segAttr.p0_to_p.dot(e.dir),this.segAttr.y_p_2DSq=this.segAttr.p0_to_p_sqrnorm-this.segAttr.x_p_2D*this.segAttr.x_p_2D,this.segAttr.y_p_2D=this.segAttr.y_p_2DSq>0?Math.sqrt(this.segAttr.y_p_2DSq):0;var i=-this.segAttr.y_p_2D/e.ortho_vec_y;this.segAttr.p_proj_x=this.segAttr.x_p_2D+i*e.ortho_vec_x},st.prototype.sphereIntersect=function(t){for(var e=0;e<3;e++){if(this.sphereIntersectSegment(t,this.segParams[e],q.KS))return!0}e=0;for(var i=!0;e<5;e++){this.tmpVect.subVectors(t.center,this.planeParams[e].orig);var r=this.tmpVect.dot(this.planeParams[e].n);i=i&&r+t.r>0}return i},st.prototype.sphereIntersectSegment=function(t,e,i){this.proj_computation(t.center,e);var r=e.v[0].getThickness(),s=e.v[1].getThickness();if(this.segAttr.p_proj_x<0)return Math.sqrt(this.segAttr.p0_to_p_sqrnorm)-t.r<r*i;if(this.segAttr.p_proj_x>e.norm)return this.segAttr.p0_to_p.subVectors(t.center,e.v[1].getPos()),this.segAttr.p0_to_p.length()-t.r<s*i;var o=this.segAttr.x_p_2D-this.segAttr.p_proj_x,n=o*o+this.segAttr.y_p_2DSq,h=this.segAttr.p_proj_x/e.norm,a=r*(1-h)+h*s,c=t.r+a*i;return n<c*c},st.prototype.contains=function(t){var e={r:0,c:t};return this.sphereIntersect(e)},st.prototype.getAccSegment=function(t,e){var i={intersect:!1,currAcc:K.nice*this.min_thick};if(this.sphereIntersectSegment(t,e,1)){var r=Math.abs(e.diffThick)/e.norm,s=t.r*Math.sqrt(1+r*r)*.5,o=e.v[0].getThickness(),n=e.v[1].getThickness(),h=this.segAttr.p_proj_x;if((h+=o>n?s:-s)<=0)i.currAcc=o;else if(h>=e.norm)i.currAcc=n;else{var a=h/e.norm;i.currAcc=o*(1-a)+a*n}i.intersect=!0}return i},st.prototype.getAccTri=function(t){if(this.equal_weights)return this.min_thick;var e=this.v[0].getPos(),i=this.tmpVect.addVectors(t.center,this.main_dir.clone().multiplyScalar(t.r));this.tmpVect.subVectors(i,e);var r=this.tmpVect.lengthSq(),s=this.tmpVect.dot(this.unit_normal),o=Math.sqrt(r-s*s),n=this.tmpVect.clone().addVectors(t.center,this.unit_normal.clone().multiplyScalar(-s)),h=rt.getTriBaryCoord(this.p0p1,this.p2p0,this.v[0].getPos(),n),a=rt.getMeanThick(this,h.u,h.v);a=s>=0?a:-a;var c=o+-s/o*(this.v[0].getThickness()-a),p=this.tmpVect.subVectors(e,n).normalize(),l=this.tmpVect.addVectors(n,p.multiplyScalar(o-c));return(h=rt.getTriBaryCoord(this.p0p1,this.p2p0,this.v[0].getPos(),l)).u<=1&&h.v<=1&&h.u+h.v<=1&&h.u>=0&&h.v>=0?rt.getMeanThick(this,h.u,h.v):1e4*this.max_thick},st.prototype.getAcc=function(t,e){for(var i=0,r=1e5*this.max_thick;i<3;i++){var s=this.getAccSegment(t,this.segParams[i]);s.intersect&&(r=r>s.currAcc?s.currAcc:r)}var o=1e5*this.max_thick;r!==this.min_thick&&(o=this.getAccTri(t));var n=Math.min(r,o);return n!==1e5*this.max_thick?n*e:this.max_thick*e},st.prototype.getNiceAcc=function(t){return this.getAcc(t,K.nice)},st.prototype.getCurrAcc=function(t){return this.getAcc(t,K.curr)},st.prototype.getRawAcc=function(t){return this.getAcc(t,ScalisAccuracies.raw)},st.prototype.getMinAcc=function(){return K.curr*this.min_thick},st.prototype.getMinRawAcc=function(){return ScalisAccuracies.raw*this.min_thick},st.prototype.getAxisProjectionMinStep=function(t,e){for(var i=Number.MAX_VALUE,r=0;r<3;++r)i=Math.min(i,this.segAreas[r].getAxisProjectionMinStep(t,e));return i};var ot={},nt=function(e,i,r){z.call(this),this.volType=i,this.materials=null!==r?r:[m.defaultMaterial.clone(),m.defaultMaterial.clone(),m.defaultMaterial.clone()],this.v=e,this.min_thick=Math.min(this.v[0].getThickness(),this.v[1].getThickness(),this.v[2].getThickness()),this.max_thick=Math.max(this.v[0].getThickness(),this.v[1].getThickness(),this.v[2].getThickness()),this.res_gseg={},this.tmp_res_gseg={},this.ev_eps={v:0},this.p_eps=new t.Vector3,this.p0p1=new t.Vector3,this.p1p2=new t.Vector3,this.p2p0=new t.Vector3,this.unit_normal=new t.Vector3,this.unit_p0p1=new t.Vector3,this.unit_p1p2=new t.Vector3,this.unit_p2p0=new t.Vector3,this.length_p0p1=0,this.length_p1p2=0,this.length_p2p0=0,this.diffThick_p0p1=0,this.diffThick_p0p1=0,this.diffThick_p0p1=0,this.main_dir=new t.Vector3,this.point_iso_zero=new t.Vector3,this.ortho_dir=new t.Vector3,this.unsigned_ortho_dir=new t.Vector3,this.proj_dir=new t.Vector3,this.equal_weights=!1,this.coord_max=0,this.coord_middle=0,this.unit_delta_weight=0,this.longest_dir_special=0,this.max_seg_length=0,this.half_dir_1=new t.Vector3,this.point_half=new t.Vector3,this.half_dir_2=new t.Vector3,this.point_min=new t.Vector3,this.weight_min=0,this.valid_aabb=!1};(nt.prototype=Object.create(z.prototype)).constructor=nt,nt.type="ScalisTriangle",s.register(nt.type,nt),nt.prototype.getType=function(){return nt.type},nt.prototype.toJSON=function(){return z.prototype.toJSON.call(this)},nt.fromJSON=function(t){var e=[C.fromJSON(t.v[0]),C.fromJSON(t.v[1]),C.fromJSON(t.v[2])],i=[m.fromJSON(t.materials[0]),m.fromJSON(t.materials[1]),m.fromJSON(t.materials[2])];return new nt(e,t.volType,i)},nt.prototype.prepareForEval=function(){this.valid_aabb||(this.computeHelpVariables(),this.valid_aabb=!0)},nt.prototype.getAreas=function(){if(this.valid_aabb){var t=[];return t.push({norm:this.length_p0p1,diffThick:this.diffThick_p0p1,dir:this.unit_p0p1,v:[this.v[0],this.v[1]],ortho_vec_x:this.v[0].getThickness()-this.v[1].getThickness(),ortho_vec_y:this.length_p0p1}),t.push({norm:this.length_p1p2,diffThick:this.diffThick_p1p2,dir:this.unit_p1p2,v:[this.v[1],this.v[2]],ortho_vec_x:this.v[1].getThickness()-this.v[2].getThickness(),ortho_vec_y:this.length_p1p2}),t.push({norm:this.length_p2p0,diffThick:this.diffThick_p2p0,dir:this.unit_p2p0,v:[this.v[2],this.v[0]],ortho_vec_x:this.v[2].getThickness()-this.v[0].getThickness(),ortho_vec_y:this.length_p2p0}),[{aabb:this.aabb,bv:new ot(this.v,this.unit_normal,this.main_dir,t,this.min_thick,this.max_thick),obj:this}]}return console.log("ERROR : Cannot get area of invalid primitive"),[]},nt.prototype.computeHelpVariables=function(){rt.computeVectorsDirs(this),this.computeAABB()},nt.prototype.mutableVolType=function(){return!0},nt.prototype.setVolType=function(t){if(t!=z.CONVOL&&t!=z.DIST)throw"ERROR : volType must be set to ScalisPrimitive.CONVOL or ScalisPrimitive.DIST";this.volType!=t&&(this.volType=t,this.invalidAABB())},nt.prototype.getVolType=function(){return this.volType},nt.prototype.clamp=function(t,e,i){return Math.max(e,Math.min(i,t))},nt.prototype.distanceTo=function(){var e=new t.Vector3,i=new t.Vector3,r=new t.Vector3,s=new t.Vector3;return function(t){if(e.subVectors(t,this.v[0].getPos()),i.subVectors(t,this.v[1].getPos()),r.subVectors(t,this.v[2].getPos()),s.crossVectors(this.p0p1,e).dot(this.unit_normal)>0&&s.crossVectors(this.p1p2,i).dot(this.unit_normal)>0&&s.crossVectors(this.p2p0,r).dot(this.unit_normal)>0)return Math.abs(e.dot(this.unit_normal));var o=e.dot(this.p0p1)/this.length_p0p1;o=this.clamp(o,0,1),s.copy(this.p0p1).multiplyScalar(o).add(this.v[0].getPos()),o=t.distanceToSquared(s);var n=i.dot(this.p1p2)/this.length_p1p2;n=this.clamp(n,0,1),s.copy(this.p1p2).multiplyScalar(n).add(this.v[1].getPos()),n=t.distanceToSquared(s);var h=r.dot(this.p2p0)/this.length_p2p0;return h=this.clamp(h,0,1),s.copy(this.p2p0).multiplyScalar(h).add(this.v[2].getPos()),h=t.distanceToSquared(s),Math.sqrt(Math.min(Math.min(o,n),h))}}(),nt.prototype.heuristicStepWithin=function(){return this.weight_min/3},nt.prototype.value=function(t,e,i){switch(this.volType){case z.DIST:return this.evalDist(t,e,i);case z.CONVOL:return this.evalConvol(t,e,i);default:throw"Unknown volType, use Orga"}},nt.prototype.evalDist=function(e,i,r){var s=new t.Vector3;s.subVectors(e,this.v[0].getPos());var n=this.unit_normal.clone().multiplyScalar(-1);if(!this.equal_weights){var h=n,a=this.unsigned_ortho_dir,c=this.main_dir.clone().multiplyScalar(-1),p=-this.v[0].getPos().dot(h),l=-e.dot(a),u=-this.point_iso_zero.dot(c),_=new t.Vector3;_.crossVectors(a,c),_.multiplyScalar(-p);var v=new t.Vector3;v.crossVectors(c,h),v.multiplyScalar(-l);var m=new t.Vector3;m.crossVectors(h,a),m.multiplyScalar(-u);var g=new t.Vector3;g.crossVectors(a,c);var y=new t.Vector3(_.x+v.x+m.x,_.y+v.y+m.y,_.z+v.z+m.z);y.divideScalar(h.dot(g));var d=new t.Vector3(y.x-e.x,y.y-e.y,y.z-e.z);this.proj_dir=new t.Vector3,this.proj_dir.crossVectors(d,this.unsigned_ortho_dir),this.proj_dir.normalize()}var f=new t.Vector3;f.copy(this.proj_dir),f.multiplyScalar(-s.dot(n)/this.proj_dir.dot(n)),f.add(e);var b=new t.Vector3,x=new t.Vector3,w=new t.Vector3,V=new t.Vector3;if(x.subVectors(f,this.v[0].getPos()),w.subVectors(f,this.v[1].getPos()),V.subVectors(f,this.v[2].getPos()),b.crossVectors(this.unit_p0p1,x).dot(n)>0&&b.crossVectors(this.unit_p1p2,w).dot(n)>0&&b.crossVectors(this.unit_p2p0,V).dot(n)>0){b.subVectors(e,f),r.v=b.lengthSq();var S=this.v[0].getPos(),A=this.v[1].getPos(),M=this.v[2].getPos(),T=new t.Vector3;b.subVectors(A,S),T.subVectors(M,S);var N=new t.Vector3;N.crossVectors(b,T),b.subVectors(M,A),(h=new t.Vector3).crossVectors(b,w),b.subVectors(S,M),(a=new t.Vector3).crossVectors(b,V),b.subVectors(A,S),(c=new t.Vector3).crossVectors(b,x);var k=N.lengthSq(),P=N.dot(h),B=N.dot(a),F=N.dot(c),D=(P*this.v[0].getThickness()+B*this.v[1].getThickness()+F*this.v[2].getThickness())/k;r.v=q.Poly6Eval(Math.sqrt(r.v)/D)*q.Poly6NF0D,i&o.Mat&&r.m.triMean(this.materials[0],this.materials[1],this.materials[2],P,B,F,k)}else{var O=0;if(this.GenericSegmentComputation(e,this.v[0].getPos(),this.p0p1,this.length_p0p1,this.length_p0p1*this.length_p0p1,this.v[0].getThickness(),this.v[1].getThickness()-this.v[0].getThickness(),this.res_gseg),this.res_gseg.sqrdist=this.res_gseg.proj_to_p.lengthSq(),this.res_gseg.ratio=this.res_gseg.sqrdist/(this.res_gseg.weight_proj*this.res_gseg.weight_proj),this.GenericSegmentComputation(e,this.v[1].getPos(),this.p1p2,this.length_p1p2,this.length_p1p2*this.length_p1p2,this.v[1].getThickness(),this.v[2].getThickness()-this.v[1].getThickness(),this.tmp_res_gseg),this.tmp_res_gseg.sqrdist=this.tmp_res_gseg.proj_to_p.lengthSq(),this.tmp_res_gseg.ratio=this.tmp_res_gseg.sqrdist/(this.tmp_res_gseg.weight_proj*this.tmp_res_gseg.weight_proj),this.res_gseg.ratio>this.tmp_res_gseg.ratio&&(this.res_gseg.sqrdist=this.tmp_res_gseg.sqrdist,this.res_gseg.proj_to_p=this.tmp_res_gseg.proj_to_p,this.res_gseg.weight_proj=this.tmp_res_gseg.weight_proj,this.res_gseg.ratio=this.tmp_res_gseg.ratio,this.res_gseg.t=this.tmp_res_gseg.t,O=1),this.GenericSegmentComputation(e,this.v[2].getPos(),this.p2p0,this.length_p2p0,this.length_p2p0*this.length_p2p0,this.v[2].getThickness(),this.v[0].getThickness()-this.v[2].getThickness(),this.tmp_res_gseg),this.tmp_res_gseg.sqrdist=this.tmp_res_gseg.proj_to_p.lengthSq(),this.tmp_res_gseg.ratio=this.tmp_res_gseg.sqrdist/(this.tmp_res_gseg.weight_proj*this.tmp_res_gseg.weight_proj),this.res_gseg.ratio>this.tmp_res_gseg.ratio&&(this.res_gseg.sqrdist=this.tmp_res_gseg.sqrdist,this.res_gseg.proj_to_p=this.tmp_res_gseg.proj_to_p,this.res_gseg.weight_proj=this.tmp_res_gseg.weight_proj,this.res_gseg.ratio=this.tmp_res_gseg.ratio,this.res_gseg.t=this.tmp_res_gseg.t,O=2),r.v=q.Poly6Eval(Math.sqrt(this.res_gseg.sqrdist)/this.res_gseg.weight_proj)*q.Poly6NF0D,i&o.Mat)switch(O){case 0:r.m.copy(this.materials[0]),r.m.lerp(this.materials[1],this.res_gseg.t);break;case 1:r.m.copy(this.materials[1]),r.m.lerp(this.materials[2],this.res_gseg.t);break;case 2:r.m.copy(this.materials[2]),r.m.lerp(this.materials[0],this.res_gseg.t);break;default:throw"Error : seg_case unknown"}}if(i&o.Grad){this.p_eps.copy(e),this.p_eps.x+=1e-5,this.evalDist(this.p_eps,o.Value,this.ev_eps),r.g.x=(this.ev_eps.v-r.v)/1e-5,this.p_eps.x-=1e-5,this.p_eps.y+=1e-5,this.evalDist(this.p_eps,o.Value,this.ev_eps),r.g.y=(this.ev_eps.v-r.v)/1e-5,this.p_eps.y-=1e-5,this.p_eps.z+=1e-5,this.evalDist(this.p_eps,o.Value,this.ev_eps),r.g.z=(this.ev_eps.v-r.v)/1e-5}},nt.prototype.GenericSegmentComputation=function(e,i,r,s,o,n,h,a){var c=new t.Vector3;c.subVectors(e,i);var p=c.dot(r),l=c.lengthSq(),u=o*n+p*h,_=h<0?0:1;return u>0&&(_=(_=(p*n+l*h)/u)<0?0:_>1?1:_),a.proj_to_p=new t.Vector3(_*r.x-c.x,_*r.y-c.y,_*r.z-c.z),a.weight_proj=n+_*h,a.t=_,a},nt.prototype.evalConvol=function(){var e={v:0,m:new m(null,null,null)};return function(i,r,s){var n={l1:0,l2:0};if(this.ComputeTParam(i,n)){var h=n.l1,a=n.l2,c=this.weight_min+h*this.unit_delta_weight,p=this.warpAbscissa((a-h)/c),l=2*(5*p+1),u=p/l,_=u;u*=2;for(var v=0,m=new t.Vector3,g=1,y=null;g<l;g+=2)v+=(y=this.computeLineIntegral(this.unwarpAbscissa(_)*c+h,i,r)).v,r&o.Grad&&m.addVectors(m,y.g),_+=u;var d=0,f=new t.Vector3;_=0;for(g=2,y=null;g<l;g+=2)_+=u,y=this.computeLineIntegral(this.unwarpAbscissa(_)*c+h,i,r),r&o.Grad&&f.addVectors(f,y.g),d+=y.v;var b=this.computeLineIntegral(h,i,r),x=this.computeLineIntegral(a,i,r);s.v=b.v+4*v+2*d+b.v;var w=p/(3*l)*q.Poly6NF2D;if(s.v*=w,r&o.Grad){var V=new t.Vector3;V.addVectors(V,b.g),V.addVectors(V,m.multiplyScalar(4)),V.addVectors(V,f.multiplyScalar(2)),V.addVectors(V,x.g),s.g=V.multiplyScalar(w)}}else s.v=0,s.g=new t.Vector3;r&o.Mat&&(this.evalDist(i,o.Mat,e),s.m.copy(e.m))}}(),nt.prototype.warpAbscissa=function(t){var e=t*this.unit_delta_weight,i=1/(e+2),r=e*i;return 2*t*i*(1+(r*=r)*(1/3+r*(.2+r*(1/7+r*(1/9+r*(1/11+r*(1/13)))))))},nt.prototype.unwarpAbscissa=function(t){var e=t*this.unit_delta_weight;return t*(1+e*(.5+e*(1/6+e*(1/24+e*(1/120+1*e/720)))))},nt.prototype.computeLineIntegral=function(e,i,r){var s=this.weight_min+e*this.unit_delta_weight,n=new t.Vector3;n.addVectors(this.point_min,this.longest_dir_special.clone().multiplyScalar(e));var h=e<this.coord_middle?e/this.coord_middle*this.max_seg_length:(this.coord_max-e)/(this.coord_max-this.coord_middle)*this.max_seg_length;return r&o.Grad?this.consWeightEvalGradForSeg(n,s,this.ortho_dir,h,i):this.consWeightEvalForSeg(n,s,this.ortho_dir,h,i)},nt.prototype.homotheticClippingSpecial=function(t,e,i){var r=-t.z,s=-t.y,o=-t.x,n=s*s-r*o;if(n>=0){var h=s+Math.sqrt(n);if(h<0||e*h<o)return!1;var a=o/h;i.l1=a<0?0:a;var c=r*a;return i.l2=2*s<c+r*e?o/c:e,!0}return!1},nt.prototype.consWeightEvalForSeg=function(e,i,r,s,o){var n={v:0},h=new t.Vector3;h.subVectors(o,e);var a=r.dot(h),c=h.lengthSq(),p=new t.Vector3;p.set(i*i-q.KIS2*c,-q.KIS2*a,-q.KIS2);var l={l1:0,l2:0};if(this.homotheticClippingSpecial(p,s,l)){var u=1/i;p.x=1-q.KIS2*(l.l1*(l.l1-2*a)+c)*u*u,p.y=-q.KIS2*(a-l.l1)*u,n.v=this.homotheticCompactPolynomial_segment_F_i6_cste((l.l2-l.l1)*u,p)}return n},nt.prototype.consWeightEvalGradForSeg=function(e,i,r,s,o){var n={v:0,g:new t.Vector3},h=new t.Vector3;h.subVectors(o,e);var a=r.dot(h),c=h.lengthSq(),p=new t.Vector3;p.set(i*i-q.KIS2*c,-q.KIS2*a,-q.KIS2);var l={l1:0,l2:0};if(this.homotheticClippingSpecial(p,s,l)){var u=1/i;p.x=1-q.KIS2*(l.l1*(l.l1-2*a)+c)*u*u,p.y=-q.KIS2*(a-l.l1)*u;var _=new t.Vector3;this.homotheticCompactPolynomial_segment_FGradF_i6_cste((l.l2-l.l1)*u,p,_),n.v=_.x,_.y*=u;var v=r.clone();v.multiplyScalar(_.z+l.l1*_.y),h.multiplyScalar(-_.y),h.addVectors(h,v),n.g=h.multiplyScalar(6*q.KIS2*u)}return n},nt.prototype.ComputeTParam=function(e,i){var r=new t.Vector3;r.subVectors(e,this.point_min);var s=r.dot(this.main_dir),o=r.dot(this.unit_normal),n=s*s+o*o,h=new t.Vector3;return h.set(this.weight_min*this.weight_min-q.KIS2*n,-this.unit_delta_weight*this.weight_min-q.KIS2*s,this.unit_delta_weight*this.unit_delta_weight-q.KIS2),this.homotheticClippingSpecial(h,this.coord_max,i)},nt.prototype.homotheticCompactPolynomial_segment_F_i6_cste=function(t,e){var i=e.z,r=i*t,s=e.y,o=e.x,n=i*o-s*s,h=1/i,a=n*h,c=o+(-2*s+r)*t,p=r-s,l=p*(c*c),u=s*(o*o);return(1.2*(4/3*(2*n*t+p*c+s*o)*a+l+u)*a+c*l+o*u)*h/7},nt.prototype.homotheticCompactPolynomial_segment_FGradF_i6_cste=function(t,e,i){var r=e.z,s=r*t,o=e.y,n=e.x,h=r*n-o*o,a=1/r,c=h*a,p=n+(-2*o+s)*t,l=s-o,u=p*p,_=n*n,v=4/3*(2*h*t+l*p+o*n)*c+l*u+o*_,m=v*a/5,g=n*_,y=p*u;i.x=(1.2*v*c+l*y+o*g)*a/7,i.y=m,i.z=(o*m+y/6-g/6)*a};var ht=nt,at=function(){};at.prototype.constructor=at,at.type="DistanceFunctor",s.register(at.type,at),at.prototype.getType=function(){return at.type},at.prototype.toJSON=function(){return{type:this.getType()}},at.prototype.fromJSON=function(t){return s.fromJSON(t)},at.prototype.value=function(t){throw"Error : not implemented. Must be reimplemented in children classes."},at.prototype.value=function(t){throw"Error : not implemented. Must be reimplemented in children classes."},at.prototype.numericalGradient=function(t,e){var i=e||1e-5;return(this.value(t+i)-this.value(t-i))/(2*i)},at.prototype.gradient=function(t){return this.numericalGradient(t,1e-5)},at.prototype.support=function(t){return 1/0};var ct=at,pt=function(t){this.scale=t||1};(pt.prototype=Object.create(ct.prototype)).constructor=pt,pt.type="Poly6DistanceFunctor",s.register(pt.type,pt),pt.prototype.getType=function(){return pt.type},pt.prototype.toJSON=function(){var t=Blobtree.DistanceFunctor.prototype.toJSON.call(this,c);return t.scale=this.scale,t},pt.evalStandard=function(t){if(t<0)return 1;var e=1-t*t;return e>0?e*e*e:0},pt.prototype.value=function(t){var e=t/(2*this.scale);return pt.evalStandard(e+=.5)/pt.evalStandard(.5)},pt.prototype.gradient=function(t){var e=t/(2*this.scale)+.5,i=1-e*e;return i=-6/(2*this.scale)*e*i*i/pt.evalStandard(.5)},pt.prototype.support=function(t){return this.scale};var lt=pt,ut=function(){l.call(this),this.aabb.set(new THREE.Vector3(-1/0,-1/0,-1/0),new THREE.Vector3(1/0,1/0,1/0))};(ut.prototype=Object.create(l.prototype)).constructor=ut,ut.type="SDFNode",s.register(ut.type,ut),ut.prototype.getType=function(){return ut.type},ut.prototype.computeAABB=function(){},ut.prototype.computeDistanceAABB=function(t){throw"computeDistanceAABB is an abstract function of SDFNode. Please reimplement it in children classes."},ut.prototype.getAreas=function(){throw"No Areas for SDFNode, except for the SDFRootNode."},ut.prototype.distanceTo=function(t){throw"distanceTo should be reimplemented in every children classes of SDFNode."},ut.prototype.heuristicStepWithin=function(){throw"heuristicStepWithin may not make sens for all SDFNode, except for the SDFRootNode."};var _t=ut,vt=function(e,i,r){_t.call(this),this.f=e,this.material=i?i.clone():new m(null,null,null),this.addChild(r),this.tmp_res={v:0,g:new t.Vector3(0,0,0)}};(vt.prototype=Object.create(_t.prototype)).constructor=vt,vt.type="SDFRootNode",s.register(vt.type,vt),vt.prototype.getType=function(){return vt.type},vt.prototype.addChild=function(t){if(0!==this.children.length)throw"Error : SDFRootNode can have only one child.";_t.prototype.addChild.call(this,t)},vt.prototype.toJSON=function(){var t=_t.prototype.toJSON.call(this);return t.f=this.f.toJSON(),t},vt.fromJSON=function(t){var e=new vt(s.fromJSON(e.f),s.fromJSON(t.children[0]));return e},vt.prototype.prepareForEval=function(){if(!this.valid_aabb){this.aabb=new t.Box3;for(var e=0;e<this.children.length;++e){var i=this.children[e];i.prepareForEval(),this.aabb.union(i.computeDistanceAABB(this.f.support()))}this.valid_aabb=!0}},vt.prototype.getAreas=function(){if(this.valid_aabb)return this.children[0].getAreas(this.f.support());throw"ERROR : Cannot get area of invalid node"},vt.prototype.value=function(t,e,i){var r=this.tmp_res;i.v=0,e&o.Mat&&i.m.copy(m.defaultMaterial),e&o.Grad?i.g.set(0,0,0):e&o.NextStep&&(i.step=1e9),this.aabb.containsPoint(t)?(this.children[0].value(t,e,r),i.v=this.f.value(r.v),e&o.Grad&&i.g.copy(r.g).multiplyScalar(this.f.gradient(i.v)),e&&o.Mat&&i.m.copy(this.material)):e&o.NextStep&&(i.step=this.aabb.distanceToPoint(t)+.3)};var mt=vt,gt=function(){a.call(this),this.aabb.set(new THREE.Vector3(-1/0,-1/0,-1/0),new THREE.Vector3(1/0,1/0,1/0))};(gt.prototype=Object.create(a.prototype)).constructor=gt,gt.type="SDFPrimitive",s.register(gt.type,gt),gt.prototype.SDFPrimitive=function(){return gt.type},gt.prototype.computeAABB=function(){},gt.prototype.computeDistanceAABB=function(t){throw"computeDistanceAABB is an abstract function of SDFPrimitive. Please reimplement it in children classes."},gt.prototype.getAreas=function(){throw"No Areas for SDFPrimitive."},gt.prototype.distanceTo=function(){var t={v:0};return function(e){return this.value(e,EvalTags.Value,t),t.v}}(),gt.prototype.heuristicStepWithin=function(){throw"Not implemented"};var yt,dt=gt,ft=function(e,i,r){J.call(this),this.p=new t.Vector3(e.x,e.y,e.z),this.r=i,this.accFactor=r||1};(ft.prototype=Object.create(J.prototype)).constructor=ft,ft.prototype.sphereIntersect=(yt=new t.Vector3,function(t){yt.subVectors(t.center,this.p);var e=t.radius+this.radius;return yt.lengthSq()<e*e}),ft.prototype.contains=function(){var e=new t.Vector3;return function(t){return e.subVectors(t,this.p),e.lengthSq()<this.r*this.r}}(),ft.prototype.getAcc=function(t,e){return this.radius*e},ft.prototype.getNiceAcc=function(t){return this.getAcc(t,K.nice*this.accFactor)},ft.prototype.getCurrAcc=function(t){return this.getAcc(t,K.curr*this.accFactor)},ft.prototype.getRawAcc=function(t){return this.getAcc(t,K.raw*this.accFactor)},ft.prototype.getMinAcc=function(){return K.curr*this.r*this.accFactor},ft.prototype.getMinRawAcc=function(){return K.raw*this.r*this.accFactor},ft.prototype.getAxisProjectionMinStep=function(t,e){var i=1e8,r=e-this.p[t];return r<-this.r?i=Math.min(i,Math.max(Math.abs(r+this.r),K.curr*this.r*this.accFactor)):r<2*this.r&&(i=Math.min(i,K.curr*this.r*this.accFactor)),i};var bt=ft,xt=function(t,e){dt.call(this),this.p=t.clone(),this.r=e};(xt.prototype=Object.create(dt.prototype)).constructor=xt,xt.type="SDFSphere",s.register(xt.type,xt),xt.prototype.getType=function(){return xt.type},xt.prototype.toJSON=function(){var t=dt.prototype.toJSON.call(this);return t.p={x:this.p.x,y:this.p.y,z:this.p.z},t.r=this.r,t},xt.fromJSON=function(e){ScalisVertex.fromJSON(e.v[0]);return new xt(new t.Vector3(e.p.x,e.p.y,e.p.z),e.r)},xt.prototype.setRadius=function(t){this.r=t,this.invalidAABB()},xt.prototype.getRadius=function(){return this.r},xt.prototype.setPosition=function(t){this.p.copy(t),this.invalidAABB()},xt.prototype.getPosition=function(){return this.p},xt.prototype.computeDistanceAABB=function(e){return new t.Box3(this.p.clone().add(new t.Vector3(-this.r-e,-this.r-e,-this.r-e)),this.p.clone().add(new t.Vector3(this.r+e,this.r+e,this.r+e)))},xt.prototype.prepareForEval=function(){this.valid_aabb||(this.valid_aabb=!0)},xt.prototype.getAreas=function(t){if(this.valid_aabb)return[{aabb:this.computeDistanceAABB(t),bv:new bt(this.p,this.r+t,this.r/(this.r+t)),obj:this}];throw"ERROR : Cannot get area of invalid primitive"},xt.prototype.value=function(){var e=new t.Vector3;return function(t,i,r){if(!this.valid_aabb)throw"Error : PrepareForEval should have been called";e.subVectors(t,this.p);var s=e.length();r.v=s-this.r,i&o.Grad&&r.g.copy(e).multiplyScalar(1/s)}}();var wt=xt,Vt=function(e,i,r,s,o,n){J.call(this),this.p1=e.clone(),this.p2=i.clone(),this.r1=r,this.r2=s,this.accFactor1=o||1,this.accFactor2=n||1,this.unit_dir=(new t.Vector3).subVectors(i,e),this.length=this.unit_dir.length(),this.unit_dir.normalize(),this.vector=new t.Vector3,this.p1_to_p=this.vector,this.p1_to_p_sqrnorm=0,this.x_p_2D=0,this.y_p_2D=0,this.y_p_2DSq=0,this.ortho_vec_x=this.r1-this.r2,this.ortho_vec_y=this.length,this.p_proj_x=0,this.p_proj_y=0,this.abs_diff_thick=Math.abs(this.ortho_vec_x)};(Vt.prototype=Object.create(J.prototype)).constructor=Vt,Vt.prototype.proj_computation=function(t){this.p1_to_p=this.vector,this.p1_to_p.subVectors(t,this.p1),this.p1_to_p_sqrnorm=this.p1_to_p.lengthSq(),this.x_p_2D=this.p1_to_p.dot(this.unit_dir),this.y_p_2DSq=this.p1_to_p_sqrnorm-this.x_p_2D*this.x_p_2D,this.y_p_2D=this.y_p_2DSq>0?Math.sqrt(this.y_p_2DSq):0;var e=-this.y_p_2D/this.ortho_vec_y;this.p_proj_x=this.x_p_2D+e*this.ortho_vec_x,this.p_proj_y=0},Vt.prototype.sphereIntersect=function(t){if(this.proj_computation(t.center),this.p_proj_x<0)return Math.sqrt(this.p1_to_p_sqrnorm)-t.radius<this.r1;if(this.p_proj_x>this.length)return this.vector.subVectors(t.center,this.p2),Math.sqrt(this.vector.lengthSq())-t.radius<this.r2;var e=this.x_p_2D-this.p_proj_x,i=e*e+this.y_p_2DSq,r=this.p_proj_x/this.length,s=this.r1*(1-r)+r*this.r2,o=t.radius+s;return i<o*o},Vt.prototype.contains=function(t){if(this.proj_computation(t),this.p_proj_x<0)return this.p1_to_p_sqrnorm<this.r1*this.r1;if(this.p_proj_x>this.length)return this.vector.subVectors(t,this.p2),this.vector.lengthSq()<this.r2*this.r2;var e=this.x_p_2D-this.p_proj_x,i=this.y_p_2D-this.p_proj_y,r=e*e+i*i,s=this.p_proj_x/this.length,o=this.r1*(1-s)+s*this.r2;return r<o*o},Vt.prototype.getAcc=function(t,e){this.proj_computation(t.center);var i=this.abs_diff_thick/this.length,r=t.radius*Math.sqrt(1+i*i)*.5,s=this.p_proj_x;if((s+=this.r1>this.r2?r:-r)<0)return this.r1*this.accFactor1*e;if(s>this.length)return this.r2*this.accFactor2*e;var o=s/this.length;return(this.r1*this.accFactor1*(1-o)+o*this.r2*this.accFactor2)*e},Vt.prototype.getNiceAcc=function(t){return this.getAcc(t,K.nice)},Vt.prototype.getCurrAcc=function(t){return this.getAcc(t,K.curr)},Vt.prototype.getRawAcc=function(t){return this.getAcc(t,K.raw)},Vt.prototype.getMinAcc=function(){return K.curr*Math.min(this.r1*this.accFactor1,this.r2*this.accFactor2)},Vt.prototype.getMinRawAcc=function(){return K.raw*Math.min(this.r1*this.accFactor1,this.r2*this.accFactor2)},Vt.prototype.getAxisProjectionMinStep=function(t,e){var i,r,s,o=Number.MAX_VALUE,n=this.p1[t]<this.p2[t]?this.p1:this.p2;n===this.p1?(i=this.p2,r=this.r1*this.accFactor1,s=this.r2*this.accFactor2):(i=this.p1,r=this.r2,s=this.r1*this.accFactor1);var h=e-n[t];h<-2*r?o=Math.min(o,Math.max(Math.abs(h+2*r),K.curr*r)):h<2*r&&(o=Math.min(o,K.curr*r)),(h=e-i[t])<-2*s?o=Math.min(o,Math.max(Math.abs(h+2*s),K.curr*s)):h<2*s&&(o=Math.min(o,K.curr*s));var a=e-n[t],c=i[t]-n[t];return a>0&&a<c&&0!==c&&(o=Math.min(o,K.curr*(r+a/c*(s-r)))),o};var St=Vt,At=function(e,i,r,s){dt.call(this),this.p1=e.clone(),this.p2=i.clone(),this.r1=r,this.r2=s,this.r1=this.r1,this.rdiff=this.r2-this.r1,this.unit_dir=(new t.Vector3).subVectors(this.p2,this.p1),this.lengthSq=this.unit_dir.lengthSq(),this.length=this.unit_dir.length(),this.unit_dir.normalize()};(At.prototype=Object.create(dt.prototype)).constructor=At,At.type="SDFCapsule",s.register(At.type,At),At.prototype.getType=function(){return At.type},At.prototype.toJSON=function(){var t=dt.prototype.toJSON.call(this);return t.p1={x:this.p1.x,y:this.p1.y,z:this.p1.z},t.r1=this.r1,t.p2={x:this.p2.x,y:this.p2.y,z:this.p2.z},t.r2=this.r2,t},At.fromJSON=function(e){ScalisVertex.fromJSON(e.v[0]);return new At(new t.Vector3(e.p1.x,e.p1.y,e.p1.z),new t.Vector3(e.p2.x,e.p2.y,e.p2.z),e.r1,e.r2)},At.prototype.setRadius1=function(t){this.r1=t,this.invalidAABB()},At.prototype.setRadius2=function(t){this.r1=t,this.invalidAABB()},At.prototype.getRadius1=function(){return this.r1},At.prototype.getRadius2=function(){return this.r2},At.prototype.setPosition1=function(t){this.p1.copy(t),this.invalidAABB()},At.prototype.setPosition2=function(t){this.p2.copy(t),this.invalidAABB()},At.prototype.getPosition1=function(){return this.p1},At.prototype.getPosition2=function(){return this.p2},At.prototype.computeDistanceAABB=function(e){var i=new t.Box3(this.p1.clone().add(new t.Vector3(-this.r1-e,-this.r1-e,-this.r1-e)),this.p1.clone().add(new t.Vector3(this.r1+e,this.r1+e,this.r1+e))),r=new t.Box3(this.p2.clone().add(new t.Vector3(-this.r2-e,-this.r2-e,-this.r2-e)),this.p2.clone().add(new t.Vector3(this.r2+e,this.r2+e,this.r2+e)));return i.union(r)},At.prototype.prepareForEval=function(){this.valid_aabb||(this.valid_aabb=!0)},At.prototype.getAreas=function(t){if(this.valid_aabb)return[{aabb:this.computeDistanceAABB(t),bv:new St(this.p1,this.p2,this.r1+t,this.r2+t,this.r1/(this.r1+t),this.r2/(this.r2+t)),obj:this}];throw"ERROR : Cannot get area of invalid primitive"},At.prototype.value=function(){var e=new t.Vector3,i=new t.Vector3;return function(r,s,n){e.subVectors(r,this.p1);var h=e.lengthSq(),a=e.dot(this.unit_dir),c=a+-Math.sqrt(Math.max(0,h-a*a))/this.length*(this.r1-this.r2),p=t._Math.clamp(c/this.length,0,1);i.copy(this.p1).lerp(this.p2,p);var l=e.subVectors(r,i).length();n.v=l-(p*this.r2+(1-p)*this.r1),s&o.Grad&&n.g.copy(e).divideScalar(l)}}();var Mt=At,Tt={EdgeVMap:[[0,4],[1,5],[2,6],[3,7],[0,2],[1,3],[4,6],[5,7],[0,1],[2,3],[4,5],[6,7]],VertexTopo:[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]]},Nt=function(e,i,r,s){if(t.Box2.call(this,e,i),null==r){var o=Math.max(this.max.x-this.min.x,this.max.y-this.min.y);this.nice_acc=o<=0?1e7:o}else this.nice_acc=r;this.raw_acc=null==s?this.nice_acc:s};(Nt.prototype=Object.create(t.Box2.prototype)).union=function(e){t.Box2.prototype.union.call(this,e),this.raw_acc=Math.min(e.raw_acc,this.raw_acc),this.nice_acc=Math.min(e.nice_acc,this.nice_acc)},Nt.prototype.getRawAcc=function(){return this.raw_acc},Nt.prototype.getNiceAcc=function(){return this.nice_acc},Nt.prototype.setRawAcc=function(t){this.raw_acc=Math.max(0,t)},Nt.prototype.setNiceAcc=function(t){this.nice_acc=Math.max(0,t)},Nt.prototype.toString=function(){return"("+this.min.x.toFixed(2)+", "+this.min.y.toFixed(2)+") -> ("+this.max.x.toFixed(2)+", "+this.max.y.toFixed(2)+") "},Nt.prototype.set=function(t,e,i,r,s,o){this.min.set(t,e),this.max.set(i,r),void 0!==s&&(this.nice_acc=s),void 0!==o&&(this.raw_acc=o)},Nt.prototype.getMinCorner=function(){return this.min};var kt,Pt,Bt=function(e,i){i=i||{};this.blobtree=e,this.detail_ratio=i.detailRatio?Math.max(.01,i.detailRatio):1,i.convergence?(this.convergence=i.convergence,this.convergence.ratio=this.convergence.ratio||.01,this.convergence.step=this.convergence.step||10):this.convergence=null,this.reso=new Int32Array(3),this.steps={x:null,y:null,z:null},this.curr_steps={x:0,y:0,z:0},this.curr_step_vol=0,this.values_xy=[null,null],this.vertices_xy=[null,null],this.areas=[],this.min_acc=1,this.values=new Array(8),this.x=0,this.y=0,this.z=0,this.mask=0,this.edge_cross=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.vertex=new t.Vector3(0,0,0),this.vertex_n=new t.Vector3(0,0,0),this.vertex_m=new m(null,null,null),this.extended=!1,this.dis_o_aabb=new t.Box3,this.ext_p=new t.Vector3,this.geometry=null};Bt.prototype.initGeometry=function(){this.geometry={position:[],normal:[],color:[],metalness:[],roughness:[],nVertices:0,faces:[],nFaces:0,addVertex:function(t){this.position.push(t.p.x,t.p.y,t.p.z),this.normal.push(t.n.x,t.n.y,t.n.z),this.color.push(t.c.r,t.c.g,t.c.b),this.roughness.push(t.r),this.metalness.push(t.m),this.nVertices++},addFace(t,e,i){this.faces.push(t,e,i),this.nFaces++}}},Bt.prototype.buildResultingBufferGeometry=function(){var e=new t.BufferGeometry;return e.addAttribute("position",new t.BufferAttribute(new Float32Array(this.geometry.position),3)),e.addAttribute("normal",new t.BufferAttribute(new Float32Array(this.geometry.normal),3)),e.addAttribute("color",new t.BufferAttribute(new Float32Array(this.geometry.color),3)),e.addAttribute("roughness",new t.BufferAttribute(new Float32Array(this.geometry.roughness),1)),e.addAttribute("metalness",new t.BufferAttribute(new Float32Array(this.geometry.metalness),1)),e.setIndex(new t.BufferAttribute(this.geometry.nVertices>65535?new Uint32Array(this.geometry.faces):new Uint16Array(this.geometry.faces),1)),e},Bt.prototype.setFrontToZero=function(){for(var t=0;t<this.values_xy[1].length;++t)this.values_xy[1][t]=0},Bt.prototype.setFrontToMinus=function(){for(var t=0;t<this.values_xy[1].length;++t)this.values_xy[1][t]=-1},Bt.prototype.setFrontToZeroIfMinus=function(){for(var t=0;t<this.values_xy[1].length;++t)-1===this.values_xy[1][t]&&(this.values_xy[1][t]=0)},Bt.prototype.interpolateInBox=function(t,e,i,r,s,o,n){var h=this.values_xy[1],a=s-r,c=n-o;if(a>1)for(var p=h[(_=o*this.reso[0])+r],l=(h[_+s]-p)/a,u=1;u<a;++u)-1===h[_+r+u]&&(h[_+r+u]=p+u*l);if(c>1){var _;for(p=h[(_=n*this.reso[0])+r],l=(h[_+s]-p)/a,u=1;u<a;++u)-1===h[_+r+u]&&(h[_+r+u]=p+u*l);for(u=0;u<=a;++u){p=h[o*this.reso[0]+r+u],l=(h[n*this.reso[0]+r+u]-p)/c;for(var v=1;v<c;++v)-1===h[(o+v)*this.reso[0]+r+u]&&(h[(o+v)*this.reso[0]+r+u]=p+v*l)}}},Bt.prototype.computeFrontValAt=function(t,e,i,r,s){this.computeFrontValAtClosure(t,e,i,r,s)},Bt.prototype.computeFrontValAtClosure=(kt={v:null,g:new t.Vector3(0,0,0),m:new m(null,null,null)},Pt=new t.Vector3,function(t,e,i,r,s){var n=s*this.reso[0]+r;kt.v=this.blobtree.getNeutralValue(),-1===this.values_xy[1][n]&&(Pt.set(t+r*this.min_acc,e+s*this.min_acc,i),this.blobtree.value(Pt,o.Value,kt),this.values_xy[1][n]=kt.v)}),Bt.prototype.computeFrontValAtBoxCorners=function(t,e,i,r,s){this.computeFrontValAt(t,e,i,r.x,r.y),this.computeFrontValAt(t,e,i,r.x,s.y),this.computeFrontValAt(t,e,i,s.x,r.y),this.computeFrontValAt(t,e,i,s.x,s.y)},Bt.prototype.computeFrontValInBox=function(t,e,i,r,s){for(var o=r.x;o<=s.x;++o)for(var n=r.y;n<=s.y;++n)this.computeFrontValAt(t,e,i,o,n)},Bt.prototype.setFrontValZeroInBox=function(t,e){for(var i=t.x;i<=e.x;++i)for(var r=t.y;r<=e.y;++r)this.values_xy[1][r*this.reso[0]+i]=0},Bt.prototype.computeBoxMask=function(t,e){var i=0;return i|=this.values_xy[1][t.y*this.reso[0]+t.x]>this.blobtree.getIsoValue()?1:0,i|=this.values_xy[1][t.y*this.reso[0]+e.x]>this.blobtree.getIsoValue()?2:0,i|=this.values_xy[1][e.y*this.reso[0]+e.x]>this.blobtree.getIsoValue()?4:0,i|=this.values_xy[1][e.y*this.reso[0]+t.x]>this.blobtree.getIsoValue()?8:0},Bt.prototype.checkZeroBox=function(t,e){return this.values_xy[1][t.y*this.reso[0]+t.x]+this.values_xy[1][t.y*this.reso[0]+e.x]+this.values_xy[1][e.y*this.reso[0]+e.x]+this.values_xy[1][e.y*this.reso[0]+t.x]},Bt.prototype.recursiveBoxComputation=function(e,i,r,s,o){var n=null,h=new t.Vector2(Math.round(s.max.x-s.min.x),Math.round(s.max.y-s.min.y));if(h.x>1&&h.x>=h.y){var a=s.min.x+Math.floor(h.x/2);n=[new Nt(s.min,new t.Vector2(a,s.max.y),1e4,1e4),new Nt(new t.Vector2(a,s.min.y),s.max,1e4,1e4)],this.computeFrontValAt(e,i,r,a,s.min.y),this.computeFrontValAt(e,i,r,a,s.max.y)}else{if(!(h.y>1))return;var c=s.min.y+Math.floor(h.y/2);n=[new Nt(s.min,new t.Vector2(s.max.x,c),1e4,1e4),new Nt(new t.Vector2(s.min.x,c),s.max,1e4,1e4)],this.computeFrontValAt(e,i,r,s.min.x,c),this.computeFrontValAt(e,i,r,s.max.x,c)}for(var p=[[],[]],l=0;l<o.length;++l)for(var u=0;u<n.length;++u)n[u].intersectsBox(o[l])&&(n[u].setRawAcc(Math.min(n[u].getRawAcc(),o[l].getRawAcc())),n[u].setNiceAcc(Math.min(n[u].getNiceAcc(),o[l].getNiceAcc())),p[u].push(o[l]));for(u=0;u<n.length;++u){var _=n[u],v=_.getSize(new t.Vector3);if(0===p[u].length)this.setFrontValZeroInBox(_.min,_.max);else if(v.x<=_.getRawAcc()&&v.y<=_.getRawAcc()){var m=this.computeBoxMask(_.min,_.max);15===m||0===m?this.interpolateInBox(e,i,r,_.min.x,_.max.x,_.min.y,_.max.y):v.x<=_.getNiceAcc()&&v.y<=_.getNiceAcc()?this.interpolateInBox(e,i,r,_.min.x,_.max.x,_.min.y,_.max.y):this.recursiveBoxComputation(e,i,r,_,p[u])}else this.recursiveBoxComputation(e,i,r,_,p[u])}},Bt.prototype.computeFrontValues=function(e,i,r){this.setFrontToMinus();var s=this.blobtree.getAreas(),o=new Nt;o.makeEmpty();for(var n=[],h=0;h<s.length;++h){var a=Math.round(s[h].bv.getMinRawAcc()*this.detail_ratio/this.min_acc),c=Math.round(s[h].bv.getMinAcc()*this.detail_ratio/this.min_acc),p=Math.max(0,Math.floor((s[h].aabb.min.x-e)/this.min_acc)),l=Math.max(0,Math.floor((s[h].aabb.min.y-i)/this.min_acc)),u=Math.min(this.reso[0]-1,Math.ceil((s[h].aabb.max.x-e)/this.min_acc)),_=Math.min(this.reso[1]-1,Math.ceil((s[h].aabb.max.y-i)/this.min_acc));n.push(new Nt(new t.Vector2(p,l),new t.Vector2(u,_),c,a)),o.union(n[n.length-1])}o.intersect(new Nt(new t.Vector2(0,0),new t.Vector2(this.reso[0],this.reso[1]),o.getNiceAcc(),o.getRawAcc())),this.computeFrontValAtBoxCorners(e,i,r,o.min,o.max),this.recursiveBoxComputation(e,i,r,o,n),this.setFrontToZeroIfMinus()},Bt.prototype.getMinAcc=function(t){for(var e=this.blobtree.getAreas(),i=Number.MAX_VALUE,r=0;r<e.length;r++){var s=e[r];if(s.aabb.intersectsBox(t)&&s.bv){var o=s.bv.getMinAcc();o<i&&(i=o)}}return i*this.detail_ratio},Bt.prototype.getMaxAcc=function(t){for(var e=this.blobtree.getAreas(),i=0,r=0;r<e.length;r++){var s=e[r];if(s.aabb.intersectsBox(t)&&s.bv){var o=s.bv.getMinAcc();o>i&&(i=o)}}return i*this.detail_ratio},Bt.prototype.compute=function(e,i,r){this.initGeometry(),this.progress=r||function(t){};var s=new Date;this.blobtree.prepareForEval();var o=null;if(e?e.clone():o=this.blobtree.getAABB(),this.extended=void 0!==i&&i,this.extended){for(var n=o.getSize(new t.Vector3),h=Math.min(Math.min(this.getMinAcc(o),n[0]),Math.min(n[1],n[2])),a=o.clone(),c=o.clone(),p=["x","y","z"],l=0;l<p.length;++l){a.max[p[l]]=o.min[p[l]]+h;var u=this.getMaxAcc(a);0!==u&&(c.min[p[l]]=c.min[p[l]]-u),a.max[p[l]]=o.max[p[l]]-h,0!==(u=this.getMaxAcc(a))&&(c.max[p[l]]=c.max[p[l]]+u)}o.copy(c)}var _=[],v=[];if(e&&(this.blobtree.externalTrim(o,_,v),this.blobtree.prepareForEval()),this.areas=this.blobtree.getAreas(),0===this.areas.length)return this.progress(100),new t.BufferGeometry;this.min_acc=0!==this.areas.length?this.areas[0].bv.getMinAcc():1;for(var m=0;m<this.areas.length;++m)this.areas[m].bv.getMinAcc()<this.min_acc&&(this.min_acc=this.areas[m].bv.getMinAcc());this.min_acc=this.min_acc*this.detail_ratio;var g=o.min,y=o.getSize(new t.Vector3);this.steps.z=new Float32Array(Math.ceil(y.z/this.min_acc)+2);g.z;this.steps.z[0]=g.z;for(var d=1,f=this.blobtree.getAreas();this.steps.z[d-1]<g.z+y.z;){var b=y.z;for(m=0;m<f.length;++m)b=Math.min(b,f[m].bv.getAxisProjectionMinStep("z",this.steps.z[d-1])*this.detail_ratio);this.steps.z[d]=this.steps.z[d-1]+b,d++}if(this.reso[2]=d,this.reso[0]=Math.ceil(y.x/this.min_acc)+2,this.reso[1]=Math.ceil(y.y/this.min_acc)+2,this.extended){m=0;for(this.dis_o_aabb.set(new t.Vector3(-1,-1,-1),new t.Vector3(-1,-1,-1));m<this.reso[2]&&-1===this.dis_o_aabb.min.z;)this.steps.z[m]>=e.min.z&&(this.dis_o_aabb.min.z=m),m++;for(m>this.reso[2]-1&&(this.dis_o_aabb.min.z=this.reso[2]-1),m=this.reso[2]-1;m>=0&&-1===this.dis_o_aabb.max.z;)this.steps.z[m]<e.max.z&&(this.dis_o_aabb.max.z=m),m--;m<0&&(this.dis_o_aabb.max.z=0),this.dis_o_aabb.min.x=Math.round((e.min.x-o.min.x)/this.min_acc),this.dis_o_aabb.min.y=Math.round((e.min.y-o.min.y)/this.min_acc),this.dis_o_aabb.max.x=this.reso[0]-2-Math.round((o.max.x-e.max.x)/this.min_acc),this.dis_o_aabb.max.y=this.reso[1]-2-Math.round((o.max.y-e.max.y)/this.min_acc)}this.values_xy[0]=new Float32Array(this.reso[0]*this.reso[1]),this.values_xy[1]=new Float32Array(this.reso[0]*this.reso[1]),this.vertices_xy[0]=new Int32Array(this.reso[0]*this.reso[1]),this.vertices_xy[1]=new Int32Array(this.reso[0]*this.reso[1]);var x=new t.Box3;this.computeFrontValues(g.x,g.y,g.z);for(var w=0,V=0;V<this.reso[2]-1;++V){var S=this.values_xy[0];this.values_xy[0]=this.values_xy[1],this.values_xy[1]=S,S=this.vertices_xy[0],this.vertices_xy[0]=this.vertices_xy[1],this.vertices_xy[1]=S;var A=this.steps.z[V+1];x.set(new t.Vector3(g.x,g.y,A-this.min_acc/64),new t.Vector3(g.x+this.reso[0]*this.min_acc,g.y+this.reso[1]*this.min_acc,A+this.min_acc/64)),this.blobtree.internalTrim(x),this.blobtree.prepareForEval(),this.computeFrontValues(g.x,g.y,A),this.blobtree.internalUntrim(x),this.blobtree.prepareForEval(),this.z=this.steps.z[V],this.curr_steps.z=this.steps.z[V+1]-this.steps.z[V],this.curr_steps.x=this.min_acc,this.curr_steps.y=this.min_acc,this.curr_step_vol=this.curr_steps.x*this.curr_steps.y*this.curr_steps.z;for(var M=0;M<this.reso[1]-1;++M)for(var T=0;T<this.reso[0]-1;++T)this.y=g.y+M*this.min_acc,this.fetchAndTriangulate(T,M,V,g);Math.round(100*V/this.reso[2])>w&&(w=Math.round(100*V/this.reso[2]),this.progress(w))}e&&(this.blobtree.untrim(_,v),this.blobtree.prepareForEval());var N=new Date;return console.log("Sliding Marching Cubes computed in "+(N-s)+"ms"),this.values_xy[0]=null,this.values_xy[1]=null,this.vertices_xy[0]=null,this.vertices_xy[1]=null,this.progress(100),this.buildResultingBufferGeometry()},Bt.prototype.fetchAndTriangulate=function(t,e,i,r){var s=e*this.reso[0]+t,o=(e+1)*this.reso[0]+t;this.values[0]=this.values_xy[0][s],this.values[1]=this.values_xy[1][s],this.values[2]=this.values_xy[0][o],this.values[3]=this.values_xy[1][o],this.values[4]=this.values_xy[0][s+1],this.values[5]=this.values_xy[1][s+1],this.values[6]=this.values_xy[0][o+1],this.values[7]=this.values_xy[1][o+1],this.computeMask(),0!==this.mask&&255!==this.mask&&(this.x=r.x+t*this.min_acc,this.computeVertex(),this.geometry.addVertex({p:this.vertex,n:this.vertex_n,c:this.vertex_m.getColor(),r:this.vertex_m.getRoughness(),m:this.vertex_m.getMetalness()}),this.vertices_xy[1][s]=this.geometry.nVertices-1,this.triangulate(t,e,i))},Bt.prototype.pushDirectFaces=function(t,e,i,r){this.geometry.addFace(t,e,i),this.geometry.addFace(i,r,t)},Bt.prototype.pushUndirectFaces=function(t,e,i,r){this.geometry.addFace(i,e,t),this.geometry.addFace(t,r,i)},Bt.prototype.triangulate=function(t,e,i){var r=e*this.reso[0]+t;if(this.edge_cross[0]&&0!==e&&0!==i){var s=this.vertices_xy[1][r],o=this.vertices_xy[1][(e-1)*this.reso[0]+t],n=this.vertices_xy[0][(e-1)*this.reso[0]+t],h=this.vertices_xy[0][r];1&this.mask?this.pushDirectFaces(s,o,n,h):this.pushUndirectFaces(s,o,n,h)}if(this.edge_cross[4]&&0!==t&&0!==i){s=this.vertices_xy[1][r],o=this.vertices_xy[0][r],n=this.vertices_xy[0][r-1],h=this.vertices_xy[1][r-1];1&this.mask?this.pushDirectFaces(s,o,n,h):this.pushUndirectFaces(s,o,n,h)}if(this.edge_cross[8]&&0!==t&&0!==e){s=this.vertices_xy[1][r],o=this.vertices_xy[1][r-1],n=this.vertices_xy[1][(e-1)*this.reso[0]+t-1],h=this.vertices_xy[1][(e-1)*this.reso[0]+t];1&this.mask?this.pushDirectFaces(s,o,n,h):this.pushUndirectFaces(s,o,n,h)}},Bt.prototype.computeVertex=function(){this.computeVertexClosure()},Bt.prototype.computeVertexClosure=function(){var e={v:null,g:new t.Vector3(0,0,0),m:new m(null,null,null)},i=new t.Vector3;return function(){e.v=this.blobtree.getNeutralValue();var t=0;this.vertex.set(0,0,0);for(var r=0;r<12;++r){var s=Tt.EdgeVMap[r][0],n=Tt.EdgeVMap[r][1],h=Tt.VertexTopo[s],a=Tt.VertexTopo[n],c=this.values[s],p=this.values[n];if(this.edge_cross[r]=c>this.blobtree.getIsoValue()!=p>this.blobtree.getIsoValue(),this.edge_cross[r]){++t;var l=p-c,u=0;Math.abs(l)>1e-6&&(u=(this.blobtree.getIsoValue()-c)/l,this.vertex.x+=(1-u)*h[0]+u*a[0],this.vertex.y+=(1-u)*h[1]+u*a[1],this.vertex.z+=(1-u)*h[2]+u*a[2])}}this.vertex.x=this.x+this.curr_steps.x*this.vertex.x/t,this.vertex.y=this.y+this.curr_steps.y*this.vertex.y/t,this.vertex.z=this.z+this.curr_steps.z*this.vertex.z/t,this.convergence&&(_.safeNewton3D(this.blobtree,this.vertex,this.blobtree.getIsoValue(),this.min_acc*this.convergence.ratio,this.convergence.step,this.min_acc,i),this.vertex.copy(i)),this.blobtree.value(this.vertex,o.ValueGradMat,e),e.g.normalize(),this.vertex_n.copy(e.g).multiplyScalar(-1),this.vertex_m.copy(e.m)}}(),Bt.prototype.computeMask=function(){this.mask=0;for(var t=0;t<8;++t){var e=this.values[t];this.mask|=e>this.blobtree.getIsoValue()?1<<t:0}};var Ft=Bt,Dt=function(){console.warn("JSON Loader is deprecated, please use Types.fromJSON(json).")};Dt.prototype.constructor=Dt,Dt.prototype.parse=function(t){return s.fromJSON(t)};var Ot=Dt;96!==t.REVISION&&console.warn("Blobtree library is currently made for THREE revision 96. Using any other revision may lead to unexpected behavior.");var zt={version:"1.0.0"};return zt.Types=s,zt.Element=a,zt.Node=l,zt.RootNode=T,zt.RicciNode=A,zt.DifferenceNode=k,zt.MinNode=B,zt.Primitive=D,zt.ScalisPrimitive=z,zt.ScalisPoint=W,zt.ScalisSegment=tt,zt.ScalisTriangle=ht,zt.ScalisVertex=C,zt.DistanceFunctor=ct,zt.Poly6DistanceFunctor=lt,zt.SDFRootNode=mt,zt.SDFPrimitive=dt,zt.SDFSphere=wt,zt.SDFCapsule=Mt,zt.ScalisPrimitive=z,zt.Material=m,zt.Accuracies=K,zt.Area=J,zt.AreaScalisPoint=L,zt.AreaScalisSeg=Q,zt.AreaScalisTri=ot,zt.AreaSphere=bt,zt.AreaCapsule=St,zt.EvalTags=o,zt.SlidingMarchingCubes=Ft,zt.JSONLoader=Ot,zt});
